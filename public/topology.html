<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMbox - å¢å¼ºç‰ˆç½‘ç»œæ‹“æ‰‘</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; }
        #network { width: 100%; height: 100%; background-color: #1e293b; }
        
        /* å³ä¾§é¢æ¿åŠ¨ç”» */
        .right-panel {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(100%);
        }
        .right-panel.open {
            transform: translateX(0);
        }
        
        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        
        .terminal-font { font-family: 'Consolas', 'Courier New', monospace; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden relative">

    <!-- é¡¶éƒ¨ -->
    <header class="bg-slate-900 border-b border-indigo-900/50 p-3 flex justify-between items-center shadow-lg z-40 shrink-0">
        <div class="flex items-center gap-3">
            <h1 class="text-lg font-bold text-indigo-400 tracking-wider">NETWORK <span class="text-slate-500">TOPOLOGY</span></h1>
            <span class="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-slate-400 border border-slate-700">v2.0 Enhanced</span>
        </div>
        <button onclick="window.location.href='/'" class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1 rounded border border-slate-700 transition">
            â† è¿”å›ä¸»é¡µ
        </button>
    </header>

    <div class="flex-1 relative flex overflow-hidden">
        
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <div class="w-72 bg-slate-800 border-r border-slate-700 p-4 flex flex-col gap-4 shrink-0 z-20 shadow-xl overflow-y-auto">
            
            <!-- æ‰«æé…ç½® -->
            <div class="bg-slate-900/50 p-3 rounded border border-slate-700">
                <h3 class="text-xs font-bold text-slate-400 mb-2 uppercase">æ‰«æé…ç½® (Configuration)</h3>
                <div class="space-y-2">
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" id="chkLive" class="accent-indigo-500 w-4 h-4 rounded border-slate-600 bg-slate-800">
                        <span class="text-xs text-slate-300 group-hover:text-white transition">ä¸»åŠ¨æ¢æ´» (-Pn, å¼ºåˆ¶æ‰«æ)</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" id="chkOs" class="accent-indigo-500 w-4 h-4 rounded border-slate-600 bg-slate-800">
                        <span class="text-xs text-slate-300 group-hover:text-white transition">è¯†åˆ«ç›®æ ‡ä¸»æœº (-O, ç³»ç»Ÿæ¢æµ‹)</span>
                    </label>
                </div>
            </div>

            <!-- æ‰«ææ§åˆ¶ -->
            <div>
                <button onclick="startScan()" id="btnScan" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded shadow transition flex items-center justify-center gap-2 text-sm">
                    å¼€å§‹å…¨ç½‘æ®µæ‰«æ
                </button>
                <div id="statusText" class="text-xs text-slate-400 mt-2 text-center">å°±ç»ª</div>
            </div>

            <!-- è¿›åº¦æ¡ -->
            <div class="bg-slate-700 rounded-full h-1.5 w-full overflow-hidden mt-1">
                <div id="scanProgress" class="h-full bg-green-500 w-0 transition-all duration-500"></div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="bg-slate-900/50 rounded p-3 text-xs space-y-2 border border-slate-700">
                <div class="flex justify-between">
                    <span class="text-slate-400">å‘ç°è®¾å¤‡:</span>
                    <span id="countVal" class="text-white font-bold">0</span>
                </div>
                <div class="h-px bg-slate-700 my-2"></div>
                <!-- å›¾ä¾‹ -->
                <div class="space-y-1.5">
                    <div class="flex items-center gap-2"><div class="w-2.5 h-2.5 rounded-sm bg-purple-500 shadow shadow-purple-500/50"></div> <span class="text-slate-300">ç½‘å…³ (Gateway)</span></div>
                    <div class="flex items-center gap-2"><div class="w-2.5 h-2.5 rounded-full bg-blue-500 shadow shadow-blue-500/50"></div> <span class="text-slate-300">æœ¬æœº (Attacker)</span></div>
                    <div class="flex items-center gap-2"><div class="w-2.5 h-2.5 rounded-full bg-green-500 shadow shadow-green-500/50"></div> <span class="text-slate-300">ç›®æ ‡è®¾å¤‡ (Target)</span></div>
                </div>
            </div>

            <!-- å®æ—¶æ—¥å¿— -->
            <div class="flex-1 bg-black rounded p-2 overflow-y-auto font-mono text-[10px] text-green-400 border border-slate-700" id="scanLog">
                > ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ.
            </div>
        </div>

        <!-- æ‹“æ‰‘ç”»å¸ƒ -->
        <div id="network" class="flex-1 relative bg-slate-900 z-10" onclick="closeRightPanelIfClickedBackground(event)">
            <!-- æç¤ºæ–‡å­— -->
            <div class="absolute top-4 left-4 text-slate-600 text-xs pointer-events-none select-none z-0">
                æç¤º: æ»šè½®ç¼©æ”¾ï¼Œæ‹–æ‹½ç§»åŠ¨ï¼Œç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ…
            </div>
        </div>
        
        <!-- å³ä¾§è¯¦æƒ…é¢æ¿ (é»˜è®¤éšè—) -->
        <div id="rightPanel" class="absolute right-0 top-0 bottom-0 w-80 bg-slate-800 border-l border-slate-700 shadow-2xl right-panel z-30 flex flex-col">
            <!-- é¢æ¿å¤´éƒ¨ -->
            <div class="p-4 border-b border-slate-700 bg-slate-900/50 flex justify-between items-center">
                <h2 class="text-sm font-bold text-white flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    èŠ‚ç‚¹è¯¦æƒ… (Node Details)
                </h2>
                <button onclick="closeRightPanel()" class="text-slate-400 hover:text-white transition">âœ–</button>
            </div>

            <!-- èŠ‚ç‚¹ä¿¡æ¯ -->
            <div class="p-4 space-y-3 border-b border-slate-700">
                <div class="bg-slate-900 p-3 rounded border border-slate-700">
                    <div class="text-[10px] text-slate-500 uppercase tracking-wider mb-1">IP Address</div>
                    <div id="detail-ip" class="text-lg font-mono text-blue-400 font-bold select-all">---</div>
                </div>
                
                <div class="grid grid-cols-1 gap-2">
                    <div class="bg-slate-900 p-2 rounded border border-slate-700">
                        <div class="text-[10px] text-slate-500 uppercase">MAC Address</div>
                        <div id="detail-mac" class="text-xs font-mono text-slate-300 select-all">---</div>
                    </div>
                    <div class="bg-slate-900 p-2 rounded border border-slate-700">
                        <div class="text-[10px] text-slate-500 uppercase">Vendor (å‚å•†)</div>
                        <div id="detail-vendor" class="text-xs text-slate-300">---</div>
                    </div>
                    <div class="bg-slate-900 p-2 rounded border border-slate-700">
                        <div class="text-[10px] text-slate-500 uppercase">OS (æ“ä½œç³»ç»Ÿ)</div>
                        <div id="detail-os" class="text-xs text-yellow-400">---</div>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="p-4 space-y-2 flex-1 overflow-y-auto">
                <h3 class="text-xs font-bold text-slate-400 mb-2 uppercase">å•ç‚¹æ“ä½œ (Actions)</h3>
                
                <button onclick="singleScan('port')" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-2 px-3 rounded text-xs border border-slate-600 transition flex justify-between group">
                    <span>ğŸ” ç«¯å£æ‰«æ (Port Scan)</span>
                    <span class="text-slate-500 group-hover:text-slate-300">-F</span>
                </button>
                
                <button onclick="singleScan('service')" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-2 px-3 rounded text-xs border border-slate-600 transition flex justify-between group">
                    <span>ğŸ›  æœåŠ¡æ¢æµ‹ (Service Det)</span>
                    <span class="text-slate-500 group-hover:text-slate-300">-sV</span>
                </button>
                
                <button onclick="singleScan('alive')" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-2 px-3 rounded text-xs border border-slate-600 transition flex justify-between group">
                    <span>ğŸ’“ ä¸»åŠ¨æ¢æ´» (Live Check)</span>
                    <span class="text-slate-500 group-hover:text-slate-300">-PE</span>
                </button>

                <!-- è¿·ä½ ç»ˆç«¯ -->
                <div class="mt-4 flex-1 flex flex-col h-64">
                    <div class="flex justify-between items-center bg-black p-1 px-2 rounded-t border border-slate-700 border-b-0">
                        <span class="text-[10px] text-slate-500">TERMINAL OUTPUT</span>
                        <button onclick="clearSingleLog()" class="text-[10px] text-red-400 hover:text-white">Clear</button>
                    </div>
                    <div id="singleLog" class="flex-1 bg-black border border-slate-700 rounded-b p-2 overflow-y-auto terminal-font text-[10px] text-green-500 whitespace-pre-wrap leading-tight">
                        > ç­‰å¾…æŒ‡ä»¤...
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <script>
        const socket = io({ 
            transports: ['websocket'],
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000
        });
        
        // --- Vis.js ---
        const nodes = new vis.DataSet([]);
        const edges = new vis.DataSet([]);
        const container = document.getElementById('network');
        
        const data = { nodes: nodes, edges: edges };
        const options = {
            nodes: {
                borderWidth: 2,
                size: 30,
                font: { color: '#e2e8f0', face: 'monospace', size: 14, strokeWidth: 2, strokeColor: '#0f172a' },
                shadow: true
            },
            edges: {
                width: 1.5,
                color: { color: '#475569', highlight: '#6366f1' },
                smooth: { type: 'continuous' }
            },
            physics: {
                stabilization: false,
                barnesHut: { 
                    gravitationalConstant: -10000, // å¢å¤§æ’æ–¥åŠ›ï¼Œè®©èŠ‚ç‚¹æ›´åˆ†æ•£
                    springConstant: 0.04,
                    springLength: 200 // å¢åŠ è¿çº¿é•¿åº¦
                }
            },
            interaction: { hover: true, selectConnectedEdges: false }
        };

        const network = new vis.Network(container, data, options);

        // --- çŠ¶æ€å˜é‡ ---
        let currentSelectedIp = null;
        let gatewayNodeId = null;
        let attackerNodeId = 'local'; // é»˜è®¤æœ¬æœºID

        // --- æ‰«ææ§åˆ¶ ---
        const btnScan = document.getElementById('btnScan');
        const progressBar = document.getElementById('scanProgress');
        const statusText = document.getElementById('statusText');
        const logDiv = document.getElementById('scanLog');
        const countVal = document.getElementById('countVal');

        function log(msg) {
            const div = document.createElement('div');
            div.innerText = "> " + msg;
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function startScan() {
            // è·å–é€‰é¡¹
            const liveCheck = document.getElementById('chkLive').checked;
            const osDetect = document.getElementById('chkOs').checked;

            // UI é‡ç½®
            nodes.clear();
            edges.clear();
            gatewayNodeId = null;
            currentSelectedIp = null;
            closeRightPanel();
            
            countVal.innerText = "0";
            logDiv.innerHTML = "";
            
            btnScan.disabled = true;
            btnScan.classList.add('opacity-50', 'cursor-not-allowed');
            statusText.innerText = "æ‰«æè¿›è¡Œä¸­ (Nmap)...";
            statusText.classList.add('animate-pulse', 'text-yellow-400');
            progressBar.style.width = "30%"; 
            
            let mode = "æ™®é€šæ¨¡å¼";
            if (liveCheck) mode += " + ä¸»åŠ¨æ¢æ´»";
            if (osDetect) mode += " + OSè¯†åˆ«";
            
            log(`å¯åŠ¨æ‰«æ: ${mode}`);
            
            // å‘é€è¯·æ±‚
            socket.emit('start-topology-scan', { liveCheck, osDetect });
        }

        // --- Socket ç›‘å¬ ---

        socket.on('topology-node', (nodeData) => {
            // æ›´æ–°è®¡æ•°
            if (nodeData.group === 'target') {
                countVal.innerText = parseInt(countVal.innerText) + 1;
            }

            // æ ·å¼å®šä¹‰
            let color = '#22c55e'; // Target (Green)
            let shape = 'dot';
            let size = 25;
            let label = nodeData.label;

            if (nodeData.group === 'gateway') {
                color = '#a855f7'; // Gateway (Purple)
                shape = 'diamond';
                size = 35;
                gatewayNodeId = nodeData.id; 
            } else if (nodeData.group === 'attacker') {
                color = '#3b82f6'; // Attacker (Blue)
                shape = 'hexagon';
                size = 30;
                attackerNodeId = nodeData.id;
            }

            // æ·»åŠ /æ›´æ–°èŠ‚ç‚¹
            try {
                // å¦‚æœèŠ‚ç‚¹å·²å­˜åœ¨ï¼Œç›´æ¥æ›´æ–°ï¼Œé¿å…é‡å¤æ·»åŠ å¯¼è‡´çš„é‡ç»˜é—®é¢˜
                if (nodes.get(nodeData.id)) {
                     nodes.update({
                        id: nodeData.id,
                        label: label,
                        // ä»…æ›´æ–°å¿…è¦ä¿¡æ¯
                        meta: {
                            ip: nodeData.ip,
                            mac: nodeData.mac || 'Unknown',
                            vendor: nodeData.vendor || 'Unknown',
                            os: nodeData.os || 'Unknown'
                        }
                    });
                } else {
                    nodes.add({
                        id: nodeData.id,
                        label: label,
                        color: color,
                        shape: shape,
                        size: size,
                        meta: {
                            ip: nodeData.ip,
                            mac: nodeData.mac || 'Unknown',
                            vendor: nodeData.vendor || 'Unknown',
                            os: nodeData.os || 'Unknown'
                        }
                    });
                }

                // è¿çº¿é€»è¾‘: ä¼˜å…ˆè¿æ¥ç½‘å…³ï¼Œå…¶æ¬¡è¿æ¥æœ¬æœº
                const targetId = gatewayNodeId || attackerNodeId;
                
                // åªæœ‰éæ ¸å¿ƒèŠ‚ç‚¹æ‰éœ€è¦è¿çº¿
                if (nodeData.group === 'target') {
                     // ç¡®ä¿ç›®æ ‡èŠ‚ç‚¹å­˜åœ¨æ‰è¿çº¿
                    if (targetId && targetId !== nodeData.id) {
                         const edgeId = targetId + '-' + nodeData.id;
                         if (!edges.get(edgeId)) {
                            edges.add({ id: edgeId, from: targetId, to: nodeData.id });
                         }
                    }
                } 
                // å¦‚æœæ˜¯ç½‘å…³å‡ºç°äº†ï¼Œè¦æŠŠä¹‹å‰è¿åœ¨æœ¬æœºä¸Šçš„ï¼ˆæˆ–è€…æ‚¬ç©ºçš„ï¼‰éƒ½æ‹‰è¿‡æ¥å—ï¼Ÿ
                // ç®€å•èµ·è§ï¼Œå¦‚æœç½‘å…³åå‡ºç°ï¼Œéå†æ‰€æœ‰ Target é‡æ–°è¿ä¸€æ¬¡
                else if (nodeData.group === 'gateway') {
                    // ç½‘å…³è¿æœ¬æœº
                    if (attackerNodeId && attackerNodeId !== nodeData.id) {
                         const edgeId = attackerNodeId + '-' + nodeData.id;
                         if (!edges.get(edgeId)) edges.add({ id: edgeId, from: attackerNodeId, to: nodeData.id });
                    }
                    
                    // éå†æ‰€æœ‰å·²å­˜åœ¨çš„ Targetï¼Œå¦‚æœå®ƒä»¬è¿˜æ²¡è¿ç½‘å…³ï¼Œå°±è¿ä¸Š
                    nodes.forEach((node) => {
                        if (node.group === 'target' || (node.meta && node.id !== gatewayNodeId)) {
                             // ç§»é™¤æ—§è¿çº¿ï¼ˆå¯é€‰ï¼Œä¸ºäº†æ•´æ´ï¼‰
                             // edges.remove(attackerNodeId + '-' + node.id); 
                             
                             const edgeId = gatewayNodeId + '-' + node.id;
                             if (!edges.get(edgeId)) edges.add({ id: edgeId, from: gatewayNodeId, to: node.id });
                        }
                    });
                }

                log(`å‘ç°: ${nodeData.ip} [${nodeData.group}]`);

            } catch (e) { console.warn(e); }
        });

        socket.on('topology-finish', () => {
            progressBar.style.width = "100%";
            statusText.innerText = "æ‰«æå®Œæˆ";
            statusText.classList.remove('animate-pulse', 'text-yellow-400');
            statusText.classList.add('text-green-400');
            btnScan.disabled = false;
            btnScan.classList.remove('opacity-50', 'cursor-not-allowed');
            log("æ‰«æç»“æŸ.");
        });

        // --- äº¤äº’é€»è¾‘ ---

        network.on("click", function (params) {
            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                const node = nodes.get(nodeId);
                if (node) {
                    openRightPanel(node);
                }
            } else {
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                closeRightPanel();
            }
        });

        // è™½ç„¶ network click äº‹ä»¶å¤„ç†äº†èƒŒæ™¯ç‚¹å‡»ï¼Œä½†ä¸ºäº†ä¿é™©
        function closeRightPanelIfClickedBackground(e) {
            // åªæœ‰ç›´æ¥ç‚¹åœ¨ container ä¸Šæ‰ç®—ï¼Œvis.js ä¼šæ‹¦æˆªç”»å¸ƒå†…çš„ç‚¹å‡»
            // è¿™é‡Œç•™ç©ºï¼Œä¸»è¦ä¾èµ– vis network click event
        }

        const rightPanel = document.getElementById('rightPanel');
        const detailIp = document.getElementById('detail-ip');
        const detailMac = document.getElementById('detail-mac');
        const detailVendor = document.getElementById('detail-vendor');
        const detailOs = document.getElementById('detail-os');
        const singleLog = document.getElementById('singleLog');

        function openRightPanel(node) {
            currentSelectedIp = node.id; // IPä½œä¸ºID
            const meta = node.meta || {};

            detailIp.innerText = node.id;
            detailMac.innerText = meta.mac || 'N/A';
            detailVendor.innerText = meta.vendor || 'N/A';
            detailOs.innerText = meta.os || 'N/A';

            rightPanel.classList.add('open');
            
            // æ¸…ç©ºä¹‹å‰çš„æ—¥å¿—ï¼ˆå¯é€‰ï¼Œæˆ–è€…ä¿ç•™ï¼‰
            // singleLog.innerText = "> ç­‰å¾…æŒ‡ä»¤...";
        }

        function closeRightPanel() {
            rightPanel.classList.remove('open');
            currentSelectedIp = null;
        }

        // --- å•ç‚¹æ‰«æé€»è¾‘ ---

        function singleScan(type) {
            if (!currentSelectedIp) return;
            
            const btn = event.currentTarget; // è·å–ç‚¹å‡»çš„æŒ‰é’®
            btn.classList.add('opacity-70');
            setTimeout(() => btn.classList.remove('opacity-70'), 200);

            socket.emit('start-single-scan', { target: currentSelectedIp, type: type });
        }

        function clearSingleLog() {
            singleLog.innerText = "";
        }

        socket.on('single-scan-log', (msg) => {
            // åªæœ‰å½“é¢æ¿æ‰“å¼€æ—¶æ‰è¿½åŠ ï¼Œæˆ–è€…æ€»æ˜¯è¿½åŠ 
            singleLog.innerText += msg;
            singleLog.scrollTop = singleLog.scrollHeight;
        });

    </script>
</body>
</html>